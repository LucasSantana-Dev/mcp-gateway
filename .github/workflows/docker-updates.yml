# Docker Image Updates for MCP Gateway
# Aligned with base-dependencies.yml standards

name: Docker Image Updates

on:
  schedule:
    # Run every Monday at 4 AM UTC (after Renovate and MCP check, aligned with base-dependencies.yml)
    - cron: '0 4 * * 1'
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write
  issues: write

# Environment variables (aligned with base-dependencies.yml standards)
env:
  NODE_VERSION: "22"
  PYTHON_VERSION: "3.12"

jobs:
  # Check for Docker Updates
  check-updates:
    name: Check Context Forge Updates
    runs-on: ubuntu-latest
    timeout-minutes: 10

    outputs:
      status: ${{ steps.check.outputs.status }}
      current_version: ${{ steps.check.outputs.current_version }}
      latest_version: ${{ steps.check.outputs.latest_version }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Make script executable
        run: chmod +x scripts/utils/check-docker-updates.sh

      - name: Check for updates
        id: check
        run: |
          scripts/utils/check-docker-updates.sh || true

      - name: Upload update report
        if: steps.check.outputs.status == 'update-available'
        uses: actions/upload-artifact@v4
        with:
          name: docker-update-report
          path: docker-update-report.md
          retention-days: 30

      - name: Generate update summary
        if: steps.check.outputs.status == 'update-available'
        run: |
          echo "ðŸ³ Docker Update Available!"
          echo "Current: ${{ steps.check.outputs.current_version }}"
          echo "Latest: ${{ steps.check.outputs.latest_version }}"
          echo "Status: ${{ steps.check.outputs.status }}"

  # Create Update PR
  create-pr:
    name: Create Update PR
    needs: check-updates
    if: needs.check-updates.outputs.status == 'update-available'
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Download update report
        uses: actions/download-artifact@v4
        with:
          name: docker-update-report

      - name: Update docker-compose.yml
        run: |
          sed -i "s|ghcr.io/ibm/mcp-context-forge:.*|ghcr.io/ibm/mcp-context-forge:${{ needs.check-updates.outputs.latest_version }}|g" docker-compose.yml

      - name: Update cursor-mcp-wrapper.sh
        run: |
          sed -i "s|ghcr.io/ibm/mcp-context-forge:.*|ghcr.io/ibm/mcp-context-forge:${{ needs.check-updates.outputs.latest_version }}|g" scripts/cursor-mcp-wrapper.sh

      - name: Update CI workflow
        run: |
          sed -i "s|ghcr.io/ibm/mcp-context-forge:.*|ghcr.io/ibm/mcp-context-forge:${{ needs.check-updates.outputs.latest_version }}|g" .github/workflows/ci.yml

      - name: Update Makefile
        run: |
          sed -i "s|ghcr.io/ibm/mcp-context-forge:.*|ghcr.io/ibm/mcp-context-forge:${{ needs.check-updates.outputs.latest_version }}|g" Makefile

      - name: Update README.md
        run: |
          sed -i "s|ghcr.io/ibm/mcp-context-forge:[^ ]*|ghcr.io/ibm/mcp-context-forge:${{ needs.check-updates.outputs.latest_version }}|g" README.md

      - name: Update DEVELOPMENT.md
        run: |
          sed -i "s|ghcr.io/ibm/mcp-context-forge:[^ ]*|ghcr.io/ibm/mcp-context-forge:${{ needs.check-updates.outputs.latest_version }}|g" docs/DEVELOPMENT.md

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v8
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore(docker): update Context Forge to ${{ needs.check-updates.outputs.latest_version }}"
          title: "chore(docker): update Context Forge to ${{ needs.check-updates.outputs.latest_version }}"
          body: |
            ## ðŸ³ Context Forge Gateway Update

            Updates the Context Forge Docker image from `${{ needs.check-updates.outputs.current_version }}` to `${{ needs.check-updates.outputs.latest_version }}`.

            ### ðŸ”„ Changes

            - Updated `docker-compose.yml`
            - Updated `scripts/cursor-mcp-wrapper.sh`
            - Updated `.github/workflows/ci.yml`
            - Updated `Makefile`
            - Updated `README.md`
            - Updated `docs/DEVELOPMENT.md`

            ### ðŸ“‹ Testing Checklist

            - [ ] Run `make stop` to stop current stack
            - [ ] Run `make start` to start with new version
            - [ ] Run `make register` to verify gateway registration
            - [ ] Run `make verify-cursor-setup` to verify Cursor integration
            - [ ] Run `make lint` and `make test` to verify CI checks
            - [ ] Test Cursor connection with wrapper

            ### ðŸ“Š Release Notes

            View the full changelog at:
            https://github.com/IBM/mcp-context-forge/releases/tag/${{ needs.check-updates.outputs.latest_version }}

            ---

            *This PR was automatically created by the Docker update checker workflow as part of the UIForge shared GitHub patterns standardization.*
          branch: chore/update-context-forge-${{ needs.check-updates.outputs.latest_version }}
          delete-branch: true
          labels: |
            dependencies
            docker
            gateway
            automated

  # Update Summary
  update-summary:
    name: Update Summary
    runs-on: ubuntu-latest
    timeout-minutes: 3
    needs: [check-updates, create-pr]
    if: always()

    steps:
      - name: Docker Update Summary
        run: |
          echo "ðŸ³ Docker Update Process Complete!"
          echo "ðŸ“Š Check Status: ${{ needs.check-updates.result }}"
          echo "ðŸ”„ PR Creation: ${{ needs.create-pr.result }}"
          echo ""
          if [ "${{ needs.check-updates.outputs.status }}" == "update-available" ]; then
            echo "âœ… Update available and PR created"
            echo "ðŸ“¦ Current: ${{ needs.check-updates.outputs.current_version }}"
            echo "ðŸš€ Latest: ${{ needs.check-updates.outputs.latest_version }}"
          else
            echo "â„¹ï¸ No updates available"
          fi

      - name: Generate Summary Report
        if: always()
        run: |
          echo "## ðŸ³ Docker Update Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Status | Result |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Update Check | ${{ needs.check-updates.result }} | âœ… Checked or âŒ Failed |" >> $GITHUB_STEP_SUMMARY
          echo "| PR Creation | ${{ needs.create-pr.result }} | âœ… Created or â­ï¸ Skipped |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“Š Update Metrics" >> $GITHUB_STEP_SUMMARY
          echo "- **Schedule**: Weekly on Monday at 4 AM UTC" >> $GITHUB_STEP_SUMMARY
          echo "- **Image**: ghcr.io/ibm/mcp-context-forge" >> $GITHUB_STEP_SUMMARY
          if [ "${{ needs.check-updates.outputs.status }}" == "update-available" ]; then
            echo "- **Current Version**: ${{ needs.check-updates.outputs.current_version }}" >> $GITHUB_STEP_SUMMARY
            echo "- **Latest Version**: ${{ needs.check-updates.outputs.latest_version }}" >> $GITHUB_STEP_SUMMARY
            echo "- **Status**: Update available" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **Status**: No updates available" >> $GITHUB_STEP_SUMMARY
          fi
          echo "- **Automation**: Part of UIForge shared GitHub patterns" >> $GITHUB_STEP_SUMMARY
