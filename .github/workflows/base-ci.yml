name: Base CI Workflow (Shared Patterns)

on:
  workflow_call:
    inputs:
      project-type:
        description: 'Type of project (gateway, webapp, mcp)'
        required: false
        default: 'gateway'
        type: string
      node-version:
        description: 'Node.js version to use'
        required: false
        default: '24'
        type: string
      python-version:
        description: 'Python version to use'
        required: false
        default: '3.12'
        type: string
      enable-docker:
        description: 'Enable Docker builds'
        required: false
        default: true
        type: boolean
      enable-security:
        description: 'Enable security scanning'
        required: false
        default: true
        type: boolean
      enable-coverage:
        description: 'Enable coverage reporting'
        required: false
        default: true
        type: boolean
      coverage-threshold:
        description: 'Coverage threshold percentage'
        required: false
        default: '80'
        type: string
      test-parallel:
        description: 'Run tests in parallel'
        required: false
        default: true
        type: boolean
    secrets:
      CODECOV_TOKEN:
        description: 'Codecov token'
        required: false
      SNYK_TOKEN:
        description: 'Snyk token'
        required: false
      GITHUB_TOKEN:
        description: 'GitHub token'
        required: false

jobs:
  lint-python:
    name: Lint Python
    runs-on: ubuntu-latest
    if: inputs.project-type == 'gateway'
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ inputs.python-version }}
          cache: 'pip'
      - run: pip install ruff black mypy && pip install -r requirements.txt
      - run: ruff check apps/ src/ scripts/ --format=github
      - run: black --check apps/ src/ scripts/
      - run: mypy apps/tool-router/src/ --ignore-missing-imports || true

  lint-shell:
    name: Lint Shell Scripts
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - run: find . -name "*.sh" -exec shellcheck {} \;

  test-python:
    name: Test Python
    runs-on: ubuntu-latest
    needs: lint-python
    if: inputs.project-type == 'gateway'
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ inputs.python-version }}
          cache: 'pip'
      - run: pip install pytest pytest-cov pytest-mock && pip install -r requirements.txt
      - run: pytest apps/tool-router/tests/ --cov=apps/tool-router/src --cov-report=xml --cov-fail-under=${{ inputs.coverage-threshold }}
      - if: inputs.enable-coverage
        uses: codecov/codecov-action@v5
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./coverage.xml
          fail_ci_if_error: false

  build-docker:
    name: Build Docker Images
    runs-on: ubuntu-latest
    needs: test-python
    if: inputs.enable-docker && inputs.project-type == 'gateway'
    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-buildx-action@v3
      - run: docker compose -f docker-compose.yml build

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: [lint-python, lint-shell]
    if: inputs.enable-security
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.head.sha }}
      - name: Install dependencies and run Snyk
        run: |
          npm install --ignore-scripts
          npx snyk test --severity-threshold=high
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        continue-on-error: true
