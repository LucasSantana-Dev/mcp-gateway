# Snyk Security Scanning for MCP Gateway
# Enhanced to trigger on ALL pull requests with improved error handling and parallel execution

name: Snyk Security Scanning

on:
  push:
    branches: [main, master]
  pull_request:
    # Trigger on ALL pull requests regardless of branch
    types: [opened, synchronize, reopened, ready_for_review]
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:

permissions:
  contents: read
  security-events: write
  actions: read
  pull-requests: write

# Environment variables
env:
  NODE_VERSION: "22"
  PYTHON_VERSION: "3.12"
  SNYK_SEVERITY_THRESHOLD: "high"
  SNYK_ORGANIZATION: "LucasSantana-Dev"
  SNYK_FAIL_ON_SEVERITY: "high"  # Fail build on high severity issues

jobs:
  # Enhanced Snyk Dependency Scanning (Python)
  snyk-dependency-scan:
    name: Snyk Python Dependency Scan
    runs-on: ubuntu-latest
    timeout-minutes: 10

    strategy:
      matrix:
        python-version: ["3.12"]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r requirements-dev.txt

      - name: Run Snyk to check for vulnerabilities
        uses: snyk/actions/python@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --severity-threshold=${{ env.SNYK_SEVERITY_THRESHOLD }} --all-projects --org=${{ env.SNYK_ORGANIZATION }} --fail-on-severity=${{ env.SNYK_FAIL_ON_SEVERITY }}

      - name: Upload Snyk results to GitHub Code Scanning
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: snyk.sarif

  # Enhanced Snyk Code Security Analysis
  snyk-code-scan:
    name: Snyk Code Security Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run Snyk Code Analysis
        uses: snyk/actions/python@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --severity-threshold=${{ env.SNYK_SEVERITY_THRESHOLD }} --org=${{ env.SNYK_ORGANIZATION }} --fail-on-severity=${{ env.SNYK_FAIL_ON_SEVERITY }}

      - name: Upload Snyk Code results to GitHub Code Scanning
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: snyk.sarif

  # Snyk Container Scanning (if Docker files changed)
  snyk-container-scan:
    name: Snyk Container Scanning
    runs-on: ubuntu-latest
    timeout-minutes: 10
    if: |
      contains(github.event.head.commit.message, '[docker]') ||
      contains(github.event.head.commit.message, '[container]') ||
      contains(github.event.head.commit.message, '[Dockerfile]') ||
      contains(github.event.head.commit.message, '[compose]') ||
      github.event_name == 'pull_request' &&
      (contains(github.event.pull_request.changed_files, 'Dockerfile') ||
       contains(github.event.pull_request.changed_files, 'docker-compose') ||
       contains(github.event.pull_request.changed_files, '.dockerignore'))

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run Snyk Container scanning
        uses: snyk/actions/docker@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --severity-threshold=${{ env.SNYK_SEVERITY_THRESHOLD }} --org=${{ env.SNYK_ORGANIZATION }}

      - name: Upload Snyk Container results to GitHub Code Scanning
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: snyk.sarif

  # Snyk Node.js Dependency Scanning
  snyk-node-scan:
    name: Snyk Node.js Dependency Scan
    runs-on: ubuntu-latest
    timeout-minutes: 10
    if: |
      contains(github.event.head.commit.message, '[node]') ||
      contains(github.event.head.commit.message, '[npm]') ||
      contains(github.event.head.commit.message, '[package]') ||
      github.event_name == 'pull_request' &&
      (contains(github.event.pull_request.changed_files, 'package.json') ||
       contains(github.event.pull_request.changed_files, 'package-lock.json'))

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: 'package-lock.json'

      - name: Install dependencies
        run: npm install --ignore-scripts

      - name: Run Snyk to check Node.js vulnerabilities
        uses: snyk/actions/node@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --severity-threshold=${{ env.SNYK_SEVERITY_THRESHOLD }} --org=${{ env.SNYK_ORGANIZATION }} --fail-on-severity=${{ env.SNYK_FAIL_ON_SEVERITY }}

      - name: Upload Snyk Node.js results to GitHub Code Scanning
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: snyk.sarif

  # Snyk Continuous Monitoring (main branch only)
  snyk-monitor:
    name: Snyk Continuous Monitoring
    runs-on: ubuntu-latest
    timeout-minutes: 5
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Monitor dependencies with Snyk
        uses: snyk/actions/python@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --org=${{ env.SNYK_ORGANIZATION }} --project-name=forge-mcp-gateway

  # Snyk Infrastructure as Code Scanning
  snyk-iac-scan:
    name: Snyk IaC Scanning
    runs-on: ubuntu-latest
    timeout-minutes: 5
    if: |
      contains(github.event.head.commit.message, '[iac]') ||
      contains(github.event.head.commit.message, '[terraform]') ||
      contains(github.event.head.commit.message, '[infrastructure]') ||
      github.event_name == 'pull_request' &&
      (contains(github.event.pull_request.changed_files, '*.tf') ||
       contains(github.event.pull_request.changed_files, '*.yml') ||
       contains(github.event.pull_request.changed_files, 'docker-compose'))

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run Snyk IaC scanning
        uses: snyk/actions/iac@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --severity-threshold=${{ env.SNYK_SEVERITY_THRESHOLD }} --org=${{ env.SNYK_ORGANIZATION }}

      - name: Upload Snyk IaC results to GitHub Code Scanning
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: snyk.sarif

  # Enhanced Snyk Summary with PR Comments
  snyk-summary:
    name: Snyk Scan Summary
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: [snyk-dependency-scan, snyk-code-scan, snyk-monitor, snyk-node-scan]
    if: always()

    steps:
      - name: Generate Snyk Summary Report
        run: |
          echo "## ðŸ”’ Snyk Security Scan Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Scan Type | Status | Result |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Python Dependencies | ${{ needs.snyk-dependency-scan.result }} | âœ… Passed or âŒ Failed |" >> $GITHUB_STEP_SUMMARY
          echo "| Code Analysis | ${{ needs.snyk-code-scan.result }} | âœ… Passed or âŒ Failed |" >> $GITHUB_STEP_SUMMARY
          echo "| Continuous Monitoring | ${{ needs.snyk-monitor.result }} | âœ… Active or âŒ Failed |" >> $GITHUB_STEP_SUMMARY
          echo "| Node.js Dependencies | ${{ needs.snyk-node-scan.result }} | âœ… Passed or âŒ Failed |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“Š Snyk Metrics" >> $GITHUB_STEP_SUMMARY
          echo "- **Organization**: ${{ env.SNYK_ORGANIZATION }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Severity Threshold**: ${{ env.SNYK_SEVERITY_THRESHOLD }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Fail on Severity**: ${{ env.SNYK_FAIL_ON_SEVERITY }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Scan Frequency**: Daily scheduled + event-driven" >> $GITHUB_STEP_SUMMARY
          echo "- **Languages**: Python, Node.js, TypeScript, Docker, IaC" >> $GITHUB_STEP_SUMMARY
          echo "- **Project**: forge-mcp-gateway" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸš¨ Security Status" >> $GITHUB_STEP_SUMMARY
          echo "This PR has been scanned for security vulnerabilities." >> $GITHUB_STEP_SUMMARY
          echo "Please review any findings before merging." >> $GITHUB_STEP_SUMMARY

      - name: Comment on PR with Snyk Results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const issue_number = context.issue.number;

            // Get scan results
            const depScanResult = '${{ needs.snyk-dependency-scan.result }}';
            const codeScanResult = '${{ needs.snyk-code-scan.result }}';
            const nodeScanResult = '${{ needs.snyk-node-scan.result }}';

            let comment = '## ðŸ”’ Snyk Security Scan Results\n\n';
            comment += '| Scan Type | Status |\n';
            comment += '|-----------|--------|\n';
            comment += `| Python Dependencies | ${depScanResult} |\n`;
            comment += `| Code Analysis | ${codeScanResult} |\n`;
            comment += `| Node.js Dependencies | ${nodeScanResult} |\n\n`;

            comment += '### ðŸ“‹ Scan Details\n';
            comment += '- **Organization**: LucasSantana-Dev\n';
            comment += '- **Severity Threshold**: high\n';
            comment += '- **Languages**: Python, Node.js, TypeScript\n';
            comment += '- **Project**: forge-mcp-gateway\n\n';

            comment += '### âœ… Next Steps\n';
            comment += '1. Review any security findings\n';
            comment += '2. Address high severity issues before merging\n';
            comment += '3. Monitor Snyk dashboard for ongoing updates\n';

            // Add comment to PR
            github.rest.issues.createComment({
              owner,
              repo,
              issue_number,
              body: comment
            });
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # PR Status Check
  pr-status-check:
    name: PR Status Check
    runs-on: ubuntu-latest
    timeout-minutes: 2
    if: github.event_name == 'pull_request'

    steps:
      - name: Check PR Status
        run: |
          echo "## ðŸ” Pull Request Status Check" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **PR Number**: #${{ github.event.number }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Title**: ${{ github.event.pull_request.title }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Author**: ${{ github.event.pull_request.user.login }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: ${{ github.event.pull_request.head.ref }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Files Changed**: ${{ github.event.pull_request.changed_files }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Additions**: ${{ github.event.pull_request.additions }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Deletions**: ${{ github.event.pull_request.deletions }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commits**: ${{ github.event.pull_request.commits }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸš€ Snyk Integration Status" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Snyk workflow configured to run on this PR" >> $GITHUB_STEP_SUMMARY
          echo "âœ… All security scans will be executed" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Results will be uploaded to GitHub Code Scanning" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Comments will be added with scan results" >> $GITHUB_STEP_SUMMARY
