# Automated NPM Release Workflow for Core Package
# Triggers on release branch merges and version tags

name: NPM Release - Core Package

on:
  # Trigger on release branch merges or version tags
  push:
    branches: [release/core]
    tags:
      - 'core-v*'
    paths:
      - 'package.json'
      - 'src/**'
      - 'README.md'
      - 'LICENSE'

  # Allow manual triggering
  workflow_dispatch:
    inputs:
      version_type:
        description: 'Version bump type'
        required: true
        default: 'patch'
        type: choice
        options:
          - patch
          - minor
          - major
      dry_run:
        description: 'Dry run (no actual publish)'
        required: false
        default: 'false'
        type: boolean

# Environment variables
env:
  NODE_VERSION: '22'
  NPM_REGISTRY: 'https://registry.npmjs.org'

jobs:
  # Pre-release validation
  validate:
    name: Validate Release
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    outputs:
      version: ${{ steps.version.outputs.version }}
      is_prerelease: ${{ steps.version.outputs.is_prerelease }}
      
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          registry-url: ${{ env.NPM_REGISTRY }}
          
      - name: Cache node modules
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-
            
      - name: Install dependencies
        run: npm ci
        
      - name: Run linting
        run: npm run lint:check
        
      - name: Type checking
        run: npm run lint:types
        
      - name: Build package
        run: npm run build
        
      - name: Validate build output
        run: |
          echo "Checking build output..."
          if [ ! -d "build" ]; then
            echo "âŒ Build directory not found"
            exit 1
          fi
          if [ ! -f "build/index.js" ]; then
            echo "âŒ Main entry point not found"
            exit 1
          fi
          echo "âœ… Build validation passed"
          
      - name: Extract version info
        id: version
        run: |
          VERSION=$(node -p "require('./package.json').version")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          
          # Check if this is a prerelease
          if [[ "$VERSION" =~ -[a-z] ]]; then
            echo "is_prerelease=true" >> $GITHUB_OUTPUT
          else
            echo "is_prerelease=false" >> $GITHUB_OUTPUT
          fi
          
          echo "ğŸ“¦ Package version: $VERSION"
          echo "ğŸ·ï¸  Is prerelease: ${{ steps.version.outputs.is_prerelease }}"

  # Security and quality checks
  security:
    name: Security & Quality Checks
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          
      - name: Cache node modules
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-
            
      - name: Install dependencies
        run: npm ci
        
      - name: Run security audit
        run: npm audit --audit-level high
        
      - name: Check for vulnerable dependencies
        run: |
          echo "ğŸ” Checking for high-severity vulnerabilities..."
          if npm audit --json | grep -q '"high":\s*[1-9]'; then
            echo "âŒ High-severity vulnerabilities found"
            npm audit
            exit 1
          fi
          echo "âœ… No high-severity vulnerabilities found"
          
      - name: Validate package.json
        run: |
          echo "ğŸ“‹ Validating package.json..."
          
          # Check required fields
          REQUIRED_FIELDS=("name" "version" "description" "main" "keywords" "author" "license" "repository")
          for field in "${REQUIRED_FIELDS[@]}"; do
            if ! jq -e ".$field" package.json > /dev/null; then
              echo "âŒ Missing required field: $field"
              exit 1
            fi
          done
          
          # Check package name format
          PACKAGE_NAME=$(jq -r '.name' package.json)
          if [[ ! "$PACKAGE_NAME" =~ ^@([a-z0-9-]+\/)?[a-z0-9-]+$ ]]; then
            echo "âŒ Invalid package name format: $PACKAGE_NAME"
            exit 1
          fi
          
          echo "âœ… package.json validation passed"

  # Test package locally
  test:
    name: Test Package
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          
      - name: Cache node modules
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-
            
      - name: Install dependencies
        run: npm ci
        
      - name: Build package
        run: npm run build
        
      - name: Test local installation
        run: |
          echo "ğŸ§ª Testing local package installation..."
          
          # Create test directory
          mkdir -p test-install
          cd test-install
          
          # Initialize test project
          npm init -y
          npm pack ../
          
          # Install the packed package
          PACKAGE_FILE=$(ls ../@forge-mcp-gateway-client-*.tgz | head -1)
          npm install "$PACKAGE_FILE"
          
          # Test import (basic smoke test)
          node -e "
            try {
              require('@forge-mcp-gateway/client');
              console.log('âœ… Package imports successfully');
            } catch (e) {
              console.error('âŒ Package import failed:', e.message);
              process.exit(1);
            }
          "
          
          echo "âœ… Local installation test passed"

  # Version bump (if manual trigger)
  bump-version:
    name: Bump Version
    runs-on: ubuntu-latest
    timeout-minutes: 5
    if: github.event_name == 'workflow_dispatch'
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
          
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          
      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
      - name: Bump version
        run: |
          echo "ğŸ”¢ Bumping version: ${{ github.event.inputs.version_type }}"
          
          # Install npm for version bumping
          npm install -g npm@latest
          
          # Bump version
          npm version ${{ github.event.inputs.version_type }} --no-git-tag-version
          
          # Get new version
          NEW_VERSION=$(node -p "require('./package.json').version")
          echo "ğŸ“¦ New version: $NEW_VERSION"
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
          
      - name: Commit and tag
        run: |
          NEW_VERSION="${{ steps.bump-version.outputs.new_version }}"
          
          # Commit changes
          git add package.json package-lock.json
          git commit -m "chore: bump version to $NEW_VERSION"
          
          # Create and push tag
          git tag "core-v$NEW_VERSION"
          git push origin main --tags
          
        id: bump-version

  # Publish to NPM
  publish:
    name: Publish to NPM
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: [validate, security, test]
    
    environment:
      name: npm
      url: https://www.npmjs.com/package/@forge-mcp-gateway/client
      
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          registry-url: ${{ env.NPM_REGISTRY }}
          
      - name: Cache node modules
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-
            
      - name: Install dependencies
        run: npm ci
        
      - name: Build package
        run: npm run build
        
      - name: Check if dry run
        id: dry_run
        run: |
          if [ "${{ github.event.inputs.dry_run }}" = "true" ]; then
            echo "dry_run=true" >> $GITHUB_OUTPUT
            echo "ğŸ§ª This is a dry run - no actual publishing"
          else
            echo "dry_run=false" >> $GITHUB_OUTPUT
            echo "ğŸš€ This is a real publish"
          fi
          
      - name: Publish to NPM (Dry Run)
        if: steps.dry_run.outputs.dry_run == 'true'
        run: |
          echo "ğŸ§ª Dry run - checking package before publish..."
          npm pack --dry-run
          echo "âœ… Dry run completed - package is ready for publishing"
          
      - name: Publish to NPM
        if: steps.dry_run.outputs.dry_run == 'false'
        env:
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          echo "ğŸš€ Publishing to NPM..."
          
          # Configure npm token
          npm config set //registry.npmjs.org/:_authToken $NPM_TOKEN
          
          # Check if this is a prerelease
          IS_PRERELEASE="${{ needs.validate.outputs.is_prerelease }}"
          VERSION="${{ needs.validate.outputs.version }}"
          
          echo "ğŸ“¦ Publishing version: $VERSION"
          echo "ğŸ·ï¸  Prerelease: $IS_PRERELEASE"
          
          # Publish with appropriate tag
          if [ "$IS_PRERELEASE" = "true" ]; then
            echo "ğŸ·ï¸  Publishing as prerelease (next tag)"
            npm publish --access public --tag next
          else
            echo "ğŸ·ï¸  Publishing as stable (latest tag)"
            npm publish --access public
          fi
          
          echo "âœ… Published successfully!"

  # Create GitHub Release
  github-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: [validate, publish]
    if: success() && needs.publish.result == 'success'
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: Create GitHub Release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: core-v${{ needs.validate.outputs.version }}
          release_name: Core Package v${{ needs.validate.outputs.version }}
          body: |
            ## Core Package v${{ needs.validate.outputs.version }}
            
            ### ğŸš€ Changes
            - Automated release from main branch
            - Built and tested package
            - Published to NPM registry
            
            ### ğŸ“¦ Installation
            ```bash
            npm install @forge-mcp-gateway/client
            ```
            
            ### ğŸ”— Links
            - [NPM Package](https://www.npmjs.com/package/@forge-mcp-gateway/client)
            - [Documentation](https://github.com/lucassantana/forge-mcp-gateway/tree/main/src)
            
            ---
            ğŸ¤– Generated by automated release workflow
          draft: false
          prerelease: ${{ needs.validate.outputs.is_prerelease }}

  # Update documentation
  update-docs:
    name: Update Documentation
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: [validate, publish]
    if: success() && needs.publish.result == 'success'
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          
      - name: Update version in docs
        run: |
          echo "ğŸ“ Updating documentation..."
          
          VERSION="${{ needs.validate.outputs.version }}"
          
          # Update README with latest version
          sed -i.bak "s/npm install @forge-mcp-gateway-client@[0-9]\.[0-9]\.[0-9]/npm install @forge-mcp-gateway-client@$VERSION/g" README.md
          
          # Update any other documentation files
          find docs/ -name "*.md" -type f -exec sed -i.bak "s/@forge-mcp-gateway-client@[0-9]\.[0-9]\.[0-9]/@forge-mcp-gateway-client@$VERSION/g" {} \;
          
          # Commit documentation updates
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add README.md docs/ || true
          git diff --staged --quiet || git commit -m "docs: update installation instructions for v$VERSION"
          git push || true
          
          echo "âœ… Documentation updated"

  # Notify team
  notify:
    name: Notify Team
    runs-on: ubuntu-latest
    timeout-minutes: 2
    needs: [validate, publish, github-release]
    if: always()
    
    steps:
      - name: Notify Success
        if: needs.publish.result == 'success'
        run: |
          echo "ğŸ‰ Core Package published successfully!"
          echo "ğŸ“¦ Version: ${{ needs.validate.outputs.version }}"
          echo "ğŸ”— NPM: https://www.npmjs.com/package/@forge-mcp-gateway/client"
          echo "ğŸ“‹ Release: https://github.com/lucassantana/forge-mcp-gateway/releases/tag/core-v${{ needs.validate.outputs.version }}"
          
      - name: Notify Failure
        if: failure()
        run: |
          echo "âŒ Core Package release failed!"
          echo "ğŸ” Check the workflow logs for details"
          echo "ğŸ“‹ Version: ${{ needs.validate.outputs.version }}"