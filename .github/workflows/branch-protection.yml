name: Branch Protection Rules

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  # Pre-commit validation
  pre-commit:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r tool_router/requirements.txt
          pip install pre-commit

      - name: Run pre-commit checks
        run: |
          pre-commit run --all-files

  # Release branch validation
  release-validation:
    runs-on: ubuntu-latest
    if: startsWith(github.head_ref, 'release/')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate release branch
        run: |
          # Check if branch follows naming convention
          if [[ ! "${{ github.head_ref }}" =~ ^release/v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "❌ Release branch must follow pattern: release/vX.Y.Z"
            exit 1
          fi

          # Check if main branch is up to date
          git fetch origin main
          MAIN_BEHIND=$(git rev-list --count HEAD..origin/main)
          if [ "$MAIN_BEHIND" -gt 0 ]; then
            echo "❌ Main branch is $MAIN_BEHIND commits behind. Please sync first."
            exit 1
          fi

          echo "✅ Release branch validation passed"

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r tool_router/requirements.txt

      - name: Run full test suite
        run: |
          make test-python

      - name: Run security scan
        run: |
          python -m bandit -r tool_router/ -f json -o bandit-report.json
          python -m safety check --json --output safety-report.json

      - name: Check for breaking changes
        run: |
          # Check for breaking changes in configuration or API
          if git diff --name-only origin/main...HEAD | grep -E "(tool_router/core/|tool_router/ai/|pyproject\.toml|requirements\.txt)"; then
            echo "⚠️  Potential breaking changes detected in core files"
            echo "Please review carefully before merging"
          fi

  # Documentation validation
  docs-validation:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate documentation
        run: |
          # Check if README is updated
          if git diff --name-only origin/main...HEAD | grep -E "(README\.md|CHANGELOG\.md|docs/)"; then
            echo "✅ Documentation changes detected"
          else
            echo "ℹ️  No documentation changes - consider updating README or CHANGELOG"
          fi

      - name: Check API documentation
        run: |
          if [ -f "docs/api/" ]; then
            echo "✅ API documentation directory exists"
            # Validate that API docs are complete
            find docs/api/ -name "*.md" | head -5
          else
            echo "ℹ️  Consider adding API documentation"
          fi

  # Performance and load testing
  performance-validation:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r tool_router/requirements.txt

      - name: Run performance tests
        run: |
          # Run basic performance benchmarks
          cd tool_router && python -m pytest tests/performance/ -v || echo "No performance tests found"

      - name: Memory usage check
        run: |
          # Check for memory leaks in critical components
          cd tool_router && python -c "
          import psutil
          import os

          # Monitor memory usage during startup
          process = psutil.Process(os.getpid())
          initial_memory = process.memory_info().rss / 1024 / 1024  # MB
          print(f'Initial memory usage: {initial_memory:.2f} MB')

          # Simulate some work
          import time
          time.sleep(2)

          final_memory = process.memory_info().rss / 1024 / 1024  # MB
          print(f'Final memory usage: {final_memory:.2f} MB')
          print(f'Memory increase: {final_memory - initial_memory:.2f} MB')
          "
