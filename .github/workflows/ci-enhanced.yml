# Enhanced CI Pipeline for MCP Gateway
# Comprehensive testing, coverage reporting, and performance benchmarking

name: Enhanced CI Pipeline

on:
  push:
    branches: [main, master, dev, release/*, feature/*, feat/*]
  pull_request:
    branches: [main, master, dev, release/*, feature/*, feat/*]

# Environment variables
env:
  NODE_VERSION: "22"
  PYTHON_VERSION: "3.12"
  COVERAGE_THRESHOLD: "80"
  CACHE_VERSION: "v3"
  SNYK_SEVERITY_THRESHOLD: "high"
  SNYK_ORGANIZATION: "LucasSantana-Dev"
  PERFORMANCE_TEST_DURATION: "300"

jobs:
  # Enhanced Python Testing with Comprehensive Coverage
  test-python-enhanced:
    name: Enhanced Python Tests
    runs-on: ubuntu-latest
    timeout-minutes: 45
    
    strategy:
      matrix:
        python-version: ["3.12", "3.13"]
      fail-fast: false

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: "pip"
          cache-dependency-path: "requirements.txt"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest pytest-cov pytest-mock pytest-xdist
          pip install pytest-benchmark pytest-profiling
          pip install coverage[toml]
          pip install -r requirements.txt --if-present

      - name: Cache test dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ matrix.python-version }}-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-${{ matrix.python-version }}-

      - name: Run linting and formatting checks
        run: |
          pip install ruff black mypy
          ruff check . --format=github
          black --check .
          mypy . --ignore-missing-imports || true

      - name: Run unit tests with coverage
        run: |
          pytest tool_router/tests/ \
            --cov=tool_router \
            --cov-report=xml \
            --cov-report=html \
            --cov-report=term-missing \
            --cov-fail-under=${{ env.COVERAGE_THRESHOLD }} \
            -v \
            --tb=short \
            --maxfail=5 \
            --dist=loadscope \
            -n auto

      - name: Run integration tests
        run: |
          pytest tool_router/tests/integration/ \
            --cov=tool_router \
            --cov-append \
            --cov-report=xml \
            -v \
            --tb=short \
            --maxfail=3

      - name: Run performance benchmarks
        run: |
          pytest tool_router/tests/performance/ \
            --benchmark-only \
            --benchmark-json=benchmark-results-${{ matrix.python-version }}.json \
            --benchmark-sort=mean \
            -v

      - name: Generate coverage report
        run: |
          coverage report --show-missing
          coverage html -d coverage-html-${{ matrix.python-version }}

      - name: Upload coverage to Codecov
        if: matrix.python-version == '3.12'
        uses: codecov/codecov-action@v4
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./coverage.xml
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false

      - name: Upload coverage artifacts
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report-${{ matrix.python-version }}
          path: |
            coverage.xml
            coverage-html-${{ matrix.python-version }}/
          retention-days: 30

      - name: Upload benchmark results
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-results-${{ matrix.python-version }}
          path: benchmark-results-${{ matrix.python-version }}.json
          retention-days: 30

  # Security Scanning with Enhanced Coverage
  security-enhanced:
    name: Enhanced Security Scans
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Run Snyk Security Scan
        uses: snyk/actions/python@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --severity-threshold=${{ env.SNYK_SEVERITY_THRESHOLD }}

      - name: Run Bandit Security Analysis
        run: |
          pip install bandit[toml]
          bandit -r tool_router/ -f json -o bandit-report.json
          bandit -r tool_router/ -f txt

      - name: Run Safety Check
        run: |
          pip install safety
          safety check --json --output safety-report.json || true
          safety check

      - name: Upload security reports
        uses: actions/upload-artifact@v4
        with:
          name: security-reports
          path: |
            bandit-report.json
            safety-report.json
          retention-days: 30

  # Docker Build and Security Scanning
  docker-enhanced:
    name: Enhanced Docker Build & Security
    runs-on: ubuntu-latest
    timeout-minutes: 45
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker images
        run: |
          docker compose -f docker-compose.yml build
          docker compose -f docker-compose.yml build --parallel

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: |
            ghcr.io/ibm/mcp-context-forge:1.0.0-BETA-2
            forge-mcp-gateway-tool-router:latest
            forge-mcp-gateway-service-manager:latest
          format: 'sarif'
          output: 'trivy-results.sarif'

      - name: Upload Trivy scan results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: 'trivy-results.sarif'

      - name: Test Docker containers
        run: |
          docker compose -f docker-compose.yml up -d
          sleep 30
          
          # Health checks
          curl -f http://localhost:4444/health
          curl -f http://localhost:9000/health
          curl -f http://localhost:8001/health
          
          docker compose -f docker-compose.yml down

  # Performance Testing and Benchmarking
  performance-tests:
    name: Performance Tests
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install performance testing tools
        run: |
          pip install locust pytest-benchmark
          pip install -r requirements.txt --if-present

      - name: Run load tests
        run: |
          # Start services
          docker compose -f docker-compose.yml up -d
          sleep 60
          
          # Run load tests
          locust -f tests/performance/locustfile.py \
            --headless \
            --users 50 \
            --spawn-rate 5 \
            --run-time ${{ env.PERFORMANCE_TEST_DURATION }} \
            --host http://localhost:4444 \
            --html performance-report.html || true
          
          docker compose -f docker-compose.yml down

      - name: Run API performance benchmarks
        run: |
          pytest tests/performance/api_benchmarks.py \
            --benchmark-only \
            --benchmark-json=api-benchmarks.json \
            --benchmark-sort=mean

      - name: Upload performance reports
        uses: actions/upload-artifact@v4
        with:
          name: performance-reports
          path: |
            performance-report.html
            api-benchmarks.json
          retention-days: 30

  # Quality Gates and Reporting
  quality-gates:
    name: Quality Gates
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: [test-python-enhanced, security-enhanced, docker-enhanced]
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4

      - name: Generate quality report summary
        run: |
          echo "=== Quality Report Summary ==="
          echo "Coverage: $(python -c 'import json; print(json.load(open(\"coverage-summary.json\").get(\".\", 0) * 100)')%"
          echo "Security Issues: $(python -c 'import json; print(len(json.load(open(\"security-summary.json\").get(\"issues\", [])))')"
          echo "Performance Benchmarks: $(python -c 'import json; print(len(json.load(open(\"api-benchmarks.json\").get(\"benchmarks\", [])))'"

      - name: Upload quality report
        uses: actions/upload-artifact@v4
        with:
          name: quality-summary
          path: |
            coverage-summary.json
            security-summary.json
            api-benchmarks.json
          retention-days: 30

      - name: Comment PR with quality metrics
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            let comment = '## üìä Quality Metrics Report\n\n';
            
            try {
              const coverageData = JSON.parse(fs.readFileSync('coverage-summary.json', 'utf8'));
              const securityData = JSON.parse(fs.readFileSync('security-summary.json', 'utf8'));
              const perfData = JSON.parse(fs.readFileSync('api-benchmarks.json', 'utf8'));
              
              comment += '### üß™ Test Coverage\n';
              comment += `- Overall Coverage: ${(coverageData['.'] * 100).toFixed(2)}%\n`;
              comment += `- Threshold Met: ${coverageData['.'] >= 0.8 ? '‚úÖ' : '‚ùå'}\n\n';
              
              comment += '### üîí Security Scan\n';
              comment += `- Total Issues: ${securityData['issues'].length}\n`;
              comment += `- High Severity: ${securityData['severity_counts']['HIGH'] || 0}\n\n`;
              
              comment += '### ‚ö° Performance\n';
              comment += `- Benchmarks Completed: ${perfData['benchmarks'].length}\n\n';
              
              comment += '### üéØ Quality Gates\n';
              comment += `- Coverage Passed: ${coverageData['.'] >= 0.8 ? '‚úÖ' : '‚ùå'}\n';
              comment += `- Security Passed: ${(securityData['severity_counts']['HIGH'] || 0) === 0 ? '‚úÖ' : '‚ùå'}\n';
              comment += `- Performance Passed: ‚úÖ\n\n';
              comment += '\n---\n*Generated by Enhanced CI Pipeline*';
              
            } catch (error) {
              comment = '‚ö†Ô∏è Quality report generation failed. Check logs for details.';
            }
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

  # Documentation Generation
  docs-generation:
    name: Documentation Generation
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: [test-python-enhanced]
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install documentation tools
        run: |
          pip install sphinx sphinx-rtd-theme
          pip install -r requirements.txt --if-present

      - name: Generate API documentation
        run: |
          # Generate API docs from code
          sphinx-apidoc -o docs/api tool_router/ --force --module-first || true
          
          # Build documentation
          cd docs
          make html || true

      - name: Upload documentation
        uses: actions/upload-artifact@v4
        with:
          name: api-documentation
          path: docs/_build/html/
          retention-days: 30
