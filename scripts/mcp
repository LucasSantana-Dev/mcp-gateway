#!/usr/bin/env bash
#
# MCP Gateway Unified CLI Tool
#
# Provides a simplified interface for common MCP Gateway operations.
# Usage: mcp <command> [options]

set -euo pipefail

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Script directory
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"

# Load environment variables
if [ -f "$PROJECT_ROOT/.env" ]; then
    # Validate .env syntax before sourcing
    if ! bash -n "$PROJECT_ROOT/.env" 2>/dev/null; then
        echo "ERROR: .env file has syntax errors. Please fix before continuing." >&2
        exit 1
    fi
    # shellcheck disable=SC1091
    if ! source "$PROJECT_ROOT/.env"; then
        echo "ERROR: Failed to source .env file" >&2
        exit 1
    fi
fi

# Default values
GATEWAY_URL="${GATEWAY_URL:-http://localhost:4444}"

# Helper functions
info() {
    echo -e "${BLUE}â„¹${NC} $*"
}

success() {
    echo -e "${GREEN}âœ“${NC} $*"
}

error() {
    echo -e "${RED}âœ—${NC} $*" >&2
}

# Display banner with figlet (fallback to simple text)
banner() {
    local text="$1"
    local color="${2:-$BLUE}"

    if command -v figlet &> /dev/null; then
        echo -e "${color}"
        figlet -f slant "$text"
        echo -e "${NC}"
    else
        # Fallback to simple banner
        echo ""
        printf "%b\n" "${color}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
        printf "%b\n" "${color}  $text${NC}"
        printf "%b\n" "${color}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
        echo ""
    fi
}

warn() {
    echo -e "${YELLOW}âš ${NC} $*"
}

usage() {
    banner "MCP Gateway" "$BLUE"
    cat <<EOF
Unified CLI Tool

Usage: mcp <command> [options]

Commands:
  init                 Initialize MCP Gateway project
  start                Start the gateway stack
  stop                 Stop the gateway stack
  status               Check gateway health and status
  restart              Restart the gateway stack

  server               Manage virtual servers
    list               List all virtual servers
    enable <name>      Enable a virtual server
    disable <name>     Disable a virtual server
    info <name>        Get server details

  ide                  IDE configuration tools
    setup              Interactive IDE setup wizard
    config             Generate IDE configuration
    detect             Auto-detect installed IDEs

  wizard               Interactive setup wizard
  logs [service]       View gateway logs (all, gateway, tool-router, etc.)
  doctor               Run health checks and diagnostics
  completion <shell>   Generate shell completion script (bash, zsh, fish)
  help                 Show this help message

Examples:
  mcp init                        # Initialize project
  mcp start                       # Start gateway
  mcp logs                        # View all logs
  mcp logs gateway                # View gateway logs only
  mcp doctor                      # Run health checks
  mcp server list                 # List all servers
  mcp server enable cursor-search # Enable a server
  mcp ide setup                   # Run IDE setup wizard
  mcp completion bash             # Generate bash completion

For more information, see: https://github.com/lucassantana/mcp-gateway
EOF
}

# Command: init
cmd_init() {
    info "Initializing MCP Gateway..."

    # Check prerequisites
    if ! command -v docker &> /dev/null; then
        error "Docker is not installed. Please install Docker first."
        exit 1
    fi

    if ! command -v docker-compose &> /dev/null && ! docker compose version &> /dev/null; then
        error "Docker Compose is not installed. Please install Docker Compose first."
        exit 1
    fi

    # Create .env if it doesn't exist
    if [ ! -f "$PROJECT_ROOT/.env" ]; then
        if [ -f "$PROJECT_ROOT/.env.example" ]; then
            info "Creating .env from .env.example..."
            cp "$PROJECT_ROOT/.env.example" "$PROJECT_ROOT/.env"
            success ".env file created"
        else
            warn ".env.example not found, skipping .env creation"
        fi
    else
        info ".env file already exists"
    fi

    # Create data directory
    mkdir -p "$PROJECT_ROOT/data"
    success "Data directory ready"

    success "MCP Gateway initialized successfully!"
    info "Next steps:"
    echo "  1. Review and update .env file if needed"
    echo "  2. Run: mcp start"
    echo "  3. Run: mcp ide setup"
}

# Command: start
cmd_start() {
    banner "Starting" "$GREEN"
    info "Initializing MCP Gateway..."
    cd "$PROJECT_ROOT"
    make start
}

# Command: stop
cmd_stop() {
    info "Stopping MCP Gateway..."
    cd "$PROJECT_ROOT"
    make stop
}

# Command: status
cmd_status() {
    info "Checking gateway status..."
    cd "$PROJECT_ROOT"

    # Check if containers are running
    if docker compose ps | grep -q "Up"; then
        success "Gateway is running"
        docker compose ps
    else
        warn "Gateway is not running"
        echo "Run 'mcp start' to start the gateway"
    fi
}

# Command: restart
cmd_restart() {
    info "Restarting MCP Gateway..."
    cmd_stop
    sleep 2
    cmd_start
}

# Command: logs
cmd_logs() {
    local service="${1:-all}"

    info "Viewing logs for: $service"
    cd "$PROJECT_ROOT"

    case "$service" in
        all)
            docker compose logs -f --tail=100
            ;;
        gateway|tool-router|ollama|postgres|redis|uiforge)
            docker compose logs -f --tail=100 "$service"
            ;;
        *)
            error "Unknown service: $service"
            echo "Available services: all, gateway, tool-router, ollama, postgres, redis, uiforge"
            exit 1
            ;;
    esac
}

# Command: doctor
cmd_doctor() {
    banner "Health Check" "$YELLOW"
    info "Running diagnostics..."
    echo ""

    local issues=0

    # Check 1: Docker
    echo "ğŸ” Checking Docker..."
    if command -v docker &> /dev/null; then
        if docker info &> /dev/null; then
            success "Docker is installed and running"
        else
            error "Docker is installed but not running"
            echo "   â†’ Start Docker Desktop or Docker daemon"
            issues=$((issues + 1))
        fi
    else
        error "Docker is not installed"
        echo "   â†’ Install Docker from https://docker.com"
        issues=$((issues + 1))
    fi

    # Check 2: Docker Compose
    echo "ğŸ” Checking Docker Compose..."
    if command -v docker-compose &> /dev/null || docker compose version &> /dev/null; then
        success "Docker Compose is available"
    else
        error "Docker Compose is not installed"
        echo "   â†’ Install Docker Compose"
        issues=$((issues + 1))
    fi

    # Check 3: Python
    echo "ğŸ” Checking Python..."
    if command -v python3 &> /dev/null; then
        local python_version
        python_version=$(python3 --version 2>&1 | cut -d' ' -f2)
        success "Python is installed (version $python_version)"
    else
        warn "Python3 is not installed (optional for tool_router)"
        echo "   â†’ Install Python 3.9+ for tool_router MCP server"
    fi

    # Check 4: Configuration files
    echo "ğŸ” Checking configuration..."
    if [ -f "$PROJECT_ROOT/.env" ]; then
        success ".env file exists"
    else
        warn ".env file not found"
        echo "   â†’ Run 'mcp init' to create .env file"
        issues=$((issues + 1))
    fi

    if [ -f "$PROJECT_ROOT/config/virtual-servers.txt" ]; then
        local server_count
        server_count=$(grep -v '^#' "$PROJECT_ROOT/config/virtual-servers.txt" | grep -v '^[[:space:]]*$' | wc -l | tr -d ' ')
        success "Virtual servers configured ($server_count servers)"
    else
        warn "Virtual servers configuration not found"
        issues=$((issues + 1))
    fi

    # Check 5: Gateway status
    echo "ğŸ” Checking gateway status..."
    cd "$PROJECT_ROOT"
    if docker compose ps 2>/dev/null | grep -q "Up"; then
        success "Gateway is running"

        # Check gateway health endpoint
        if command -v curl &> /dev/null; then
            if curl -sf "$GATEWAY_URL/health" &> /dev/null; then
                success "Gateway health endpoint responding"
            else
                warn "Gateway health endpoint not responding"
                echo "   â†’ Gateway may still be starting up"
            fi
        fi
    else
        warn "Gateway is not running"
        echo "   â†’ Run 'mcp start' to start the gateway"
    fi

    # Check 6: Disk space
    echo "ğŸ” Checking disk space..."
    local available_space
    available_space=$(df -h "$PROJECT_ROOT" | awk 'NR==2 {print $4}')
    success "Available disk space: $available_space"

    # Summary
    echo ""
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    if [ $issues -eq 0 ]; then
        success "All checks passed! Your MCP Gateway is healthy."
    else
        warn "Found $issues issue(s) that need attention."
        echo ""
        echo "ğŸ’¡ Quick fixes:"
        echo "   â€¢ Run 'mcp init' to initialize the project"
        echo "   â€¢ Run 'mcp start' to start the gateway"
        echo "   â€¢ Check Docker Desktop is running"
    fi
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
}

# Command: completion
cmd_completion() {
    local shell="${1:-bash}"

    # Validate shell against allowlist to prevent path traversal
    case "$shell" in
        bash|zsh|fish)
            # Valid shell
            ;;
        *)
            error "Invalid shell: '$shell'"
            echo "Available shells: bash, zsh, fish"
            exit 1
            ;;
    esac

    local completion_file="$SCRIPT_DIR/completions/mcp.$shell"

    if [ ! -f "$completion_file" ]; then
        error "Completion script for '$shell' not found"
        echo "Available shells: bash, zsh, fish"
        exit 1
    fi

    cat "$completion_file"
    echo ""
    echo "# Installation instructions:"
    case "$shell" in
        bash)
            echo "# Copy the output to: /etc/bash_completion.d/mcp"
            echo "# Or add to ~/.bashrc:"
            echo "#   source <(mcp completion bash)"
            ;;
        zsh)
            echo "# Copy the output to: /usr/local/share/zsh/site-functions/_mcp"
            echo "# Or add to ~/.zshrc:"
            echo "#   source <(mcp completion zsh)"
            ;;
        fish)
            echo "# Copy the output to: ~/.config/fish/completions/mcp.fish"
            echo "# Or run:"
            echo "#   mcp completion fish > ~/.config/fish/completions/mcp.fish"
            ;;
    esac
}

# Command: server list
cmd_server_list() {
    info "Listing virtual servers..."
    cd "$PROJECT_ROOT"
    make list-enabled
}

# Command: server enable
cmd_server_enable() {
    local server_name="$1"
    if [ -z "$server_name" ]; then
        error "Server name is required"
        echo "Usage: mcp server enable <name>"
        exit 1
    fi

    info "Enabling server: $server_name"
    cd "$PROJECT_ROOT"
    make enable-server SERVER="$server_name"
}

# Command: server disable
cmd_server_disable() {
    local server_name="$1"
    if [ -z "$server_name" ]; then
        error "Server name is required"
        echo "Usage: mcp server disable <name>"
        exit 1
    fi

    info "Disabling server: $server_name"
    cd "$PROJECT_ROOT"
    make disable-server SERVER="$server_name"
}

# Command: server info
cmd_server_info() {
    local server_name="$1"
    if [ -z "$server_name" ]; then
        error "Server name is required"
        echo "Usage: mcp server info <name>"
        exit 1
    fi

    info "Getting server info: $server_name"
    cd "$PROJECT_ROOT"

    # Use REST API to get server status
    if command -v curl &> /dev/null; then
        # Capture HTTP status and response body separately
        response=$(mktemp)
        http_status=$(curl -sS -w "%{http_code}" -o "$response" "$GATEWAY_URL/api/virtual-servers/$server_name")

        if [[ "$http_status" =~ ^2[0-9][0-9]$ ]]; then
            # Success - parse JSON response
            if command -v jq &> /dev/null; then
                jq '.' "$response" || cat "$response"
            else
                cat "$response"
            fi
        else
            # Error - show status and raw response
            echo "ERROR: HTTP $http_status" >&2
            echo "Response:" >&2
            head -c 500 "$response" >&2
            echo "" >&2
        fi
        rm -f "$response"
    else
        warn "curl not found, cannot fetch server info"
        echo "Install curl or check server status in config/virtual-servers.txt"
    fi
}

# Command: ide detect
cmd_ide_detect() {
    info "Detecting installed IDEs..."

    local found_ides=()

    # Check for Windsurf
    if [ -d "$HOME/.windsurf" ] || [ -d "$HOME/Library/Application Support/Windsurf" ]; then
        found_ides+=("windsurf")
        success "Found: Windsurf"
    fi

    # Check for Cursor
    if [ -d "$HOME/.cursor" ] || [ -d "$HOME/Library/Application Support/Cursor" ]; then
        found_ides+=("cursor")
        success "Found: Cursor"
    fi

    if [ ${#found_ides[@]} -eq 0 ]; then
        warn "No IDEs detected"
        echo "Supported IDEs: Windsurf, Cursor"
    else
        info "Detected ${#found_ides[@]} IDE(s)"
    fi
}

# Command: ide config
cmd_ide_config() {
    info "Generating IDE configuration..."
    cd "$PROJECT_ROOT"

    # Interactive prompts
    echo ""
    echo "Select IDE:"
    echo "  1) Windsurf"
    echo "  2) Cursor"
    read -rp "Choice [1]: " ide_choice
    ide_choice="${ide_choice:-1}"

    case "$ide_choice" in
        1) ide="windsurf" ;;
        2) ide="cursor" ;;
        *) error "Invalid choice"; exit 1 ;;
    esac

    make "ide-$ide"
}

# Command: ide setup (wizard)
cmd_ide_setup() {
    banner "IDE Setup" "$GREEN"
    info "Starting IDE setup wizard..."

    # Detect IDEs
    cmd_ide_detect

    echo ""
    read -rp "Which IDE would you like to configure? [windsurf/cursor]: " ide
    ide="${ide:-windsurf}"

    # Check for gum (optional for enhanced menus)
    local has_gum=false
    if command -v gum &> /dev/null; then
        # Check if gum supports --preview flag
        if gum choose --help 2>&1 | grep -Fq "--preview"; then
            has_gum=true
        fi
    fi

    # Check for jq (required for JSON parsing)
    if ! command -v jq &> /dev/null; then
        error "jq is required for parsing server configuration"
        echo ""
        echo "Install jq:"
        echo "  macOS:   brew install jq"
        echo "  Linux:   apt-get install jq / yum install jq"
        echo ""
        exit 1
    fi

    # Check for virtual servers config
    if [ ! -f "$PROJECT_ROOT/config/virtual-servers.json" ]; then
        warn "No virtual servers configured yet"
        echo "  Run './scripts/gateway/register.sh' first"
        exit 1
    fi

    # Build menu options from JSON
    echo ""
    info "Loading virtual servers..."

    # Build server list from JSON
    local servers=()
    local server_names=()

    while IFS=$'\t' read -r name description icon auth tools; do
        server_names+=("$name")
        local display="$icon $name - $description [$tools tools]"
        if [ "$auth" = "true" ]; then
            display="$display "
        fi
        servers+=("$display")
    done < <(jq -r '.categories | to_entries[] | .value.servers[] |
        if .enabled then
            "\(.name)\t\(.description)\t\(.icon)\t\(.requiresAuth)\t\(.gateways | length)"
        else empty end
    ' "$PROJECT_ROOT/config/virtual-servers.json")

    if [ ${#servers[@]} -eq 0 ]; then
        warn "No enabled virtual servers found"
        exit 1
    fi

    # Use gum if available and supports preview, otherwise use bash select
    local selected=""
    if [ "$has_gum" = true ]; then
        # Enhanced menu with gum
        menu_file=$(mktemp)
        preview_script=$(mktemp)

        printf '%s\n' "${servers[@]}" > "$menu_file"

        cat > "$preview_script" << 'PREVIEW_EOF'
#!/usr/bin/env bash
server_line="$1"
server_name=$(echo "$server_line" | awk '{print $2}')
config_file="$2"

jq -r --arg name "$server_name" '
    .categories | to_entries[] | .value.servers[] |
    select(.name == $name) |
    "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" +
    "\(.icon)  \(.description)\n" +
    "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n" +
    "Tools: \(.gateways | length)\n" +
    "Authentication: " + (if .requiresAuth then "Required ğŸ”’" else "Not required" end) + "\n" +
    (if .tags then "Tags: \(.tags | join(", "))\n" else "" end) +
    "\nIncluded Tools:\n" +
    (.gateways | map("  â€¢ " + .) | join("\n"))
' "$config_file"
PREVIEW_EOF
        chmod +x "$preview_script"

        echo ""
        selected=$(gum choose --header="ğŸ“¦ Select Virtual Server" \
            --cursor="â†’ " \
            --height=15 \
            --cursor.foreground="212" \
            --preview="$preview_script {} $PROJECT_ROOT/config/virtual-servers.json" \
            < "$menu_file" || true)

        rm -f "$menu_file" "$preview_script"
    else
        # Fallback to bash built-in select
        echo ""
        echo "ğŸ“¦ Select Virtual Server:"
        echo ""

        PS3="Enter number (1-${#servers[@]}): "
        select opt in "${servers[@]}"; do
            if [ -n "$opt" ]; then
                selected="$opt"
                break
            else
                warn "Invalid selection. Please try again."
            fi
        done
    fi

    # Check if user cancelled
    if [ -z "$selected" ]; then
        warn "No server selected"
        exit 0
    fi

    echo ""

    # Extract server name from selection
    server=$(echo "$selected" | awk '{print $2}')

    # Check if server requires authentication
    requires_auth=$(jq -r --arg name "$server" '
        .categories | to_entries[] | .value.servers[] |
        select(.name == $name) | .requiresAuth // false
    ' "$PROJECT_ROOT/config/virtual-servers.json")

    # Ensure JWT if needed
    if [ "$requires_auth" = "true" ]; then
        echo ""
        source "$SCRIPT_DIR/utils/ensure-jwt.sh"
        ensure_jwt "$server" "$requires_auth" || exit 1
    fi

    # Generate config
    cd "$PROJECT_ROOT"
    info "Generating $ide configuration for server: $server"

    # Pass JWT token if available
    if [ -n "${GATEWAY_JWT:-}" ]; then
        make "ide-$ide" SERVER="$server" JWT_TOKEN="$GATEWAY_JWT"
    else
        make "ide-$ide" SERVER="$server"
    fi

    success "IDE configuration generated!"
    info "Next steps:"
    echo "  1. Copy the configuration above"
    echo "  2. Open your $ide settings"
    echo "  3. Navigate to: Settings â†’ MCP Servers"
    echo "  4. Paste the configuration"
    echo "  5. Restart your IDE"
}

# Command: wizard
cmd_wizard() {
    clear

    # Get terminal width (default to 80 if unable to detect)
    local term_width=${COLUMNS:-$(tput cols 2>/dev/null || echo 80)}

    # Calculate appropriate line length (min 40, max 80)
    local line_width=$term_width
    if [ "$line_width" -gt 80 ]; then
        line_width=80
    elif [ "$line_width" -lt 40 ]; then
        line_width=40
    fi

    # Generate separator line
    local separator=$(printf 'â”%.0s' $(seq 1 "$line_width"))

    echo ""
    echo "$separator"
    echo "  MCP Gateway - Interactive Setup Wizard"
    echo "$separator"
    echo ""
    echo "This wizard will help you set up MCP Gateway in a few simple steps."
    echo ""

    # Step 1: Check if initialized
    if [ ! -f "$PROJECT_ROOT/.env" ]; then
        info "Step 1: Initialize project"
        cmd_init
        echo ""
    else
        success "Project already initialized"
        echo ""
    fi

    # Step 2: Start gateway
    info "Step 2: Start gateway"
    read -rp "Start the gateway now? [Y/n]: " start_now
    start_now="${start_now:-Y}"

    # Normalize to lowercase and accept common variations
    start_now_lower=$(echo "$start_now" | tr '[:upper:]' '[:lower:]')
    if [[ "$start_now_lower" == "y" || "$start_now_lower" == "yes" ]]; then
        cmd_start
        echo ""
        info "Waiting for gateway to be ready..."
        sleep 5
    fi

    # Step 3: IDE setup
    info "Step 3: Configure IDE"
    read -rp "Configure an IDE now? [Y/n]: " config_ide
    config_ide="${config_ide:-Y}"

    if [[ "$config_ide" =~ ^[Yy]$ ]]; then
        cmd_ide_setup
    fi

    echo ""
    success "Setup complete!"
    info "Your MCP Gateway is ready to use."
    echo ""
    echo "Useful commands:"
    echo "  mcp status          - Check gateway status"
    echo "  mcp server list     - List all servers"
    echo "  mcp ide config      - Generate IDE config"
    echo "  mcp help            - Show all commands"
}

# Main command router
main() {
    if [ $# -eq 0 ]; then
        usage
        exit 0
    fi

    case "$1" in
        init)
            cmd_init
            ;;
        start)
            cmd_start
            ;;
        stop)
            cmd_stop
            ;;
        status)
            cmd_status
            ;;
        restart)
            cmd_restart
            ;;
        server)
            shift
            case "${1:-}" in
                list)
                    cmd_server_list
                    ;;
                enable)
                    shift
                    cmd_server_enable "$@"
                    ;;
                disable)
                    shift
                    cmd_server_disable "$@"
                    ;;
                info)
                    shift
                    cmd_server_info "$@"
                    ;;
                *)
                    error "Unknown server command: ${1:-}"
                    echo "Usage: mcp server {list|enable|disable|info}"
                    exit 1
                    ;;
            esac
            ;;
        ide)
            shift
            case "${1:-}" in
                setup)
                    cmd_ide_setup
                    ;;
                config)
                    cmd_ide_config
                    ;;
                detect)
                    cmd_ide_detect
                    ;;
                *)
                    error "Unknown ide command: ${1:-}"
                    echo "Usage: mcp ide {setup|config|detect}"
                    exit 1
                    ;;
            esac
            ;;
        wizard)
            cmd_wizard
            ;;
        logs)
            shift
            cmd_logs "$@"
            ;;
        doctor)
            cmd_doctor
            ;;
        completion)
            shift
            cmd_completion "$@"
            ;;
        help|--help|-h)
            usage
            ;;
        *)
            error "Unknown command: $1"
            echo ""
            usage
            exit 1
            ;;
    esac
}

main "$@"
