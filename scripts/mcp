#!/usr/bin/env bash
#
# MCP Gateway Unified CLI Tool
#
# Provides a simplified interface for common MCP Gateway operations.
# Usage: mcp <command> [options]

set -euo pipefail

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Script directory
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"

# Load environment variables
if [ -f "$PROJECT_ROOT/.env" ]; then
    # Validate .env syntax before sourcing
    if ! bash -n "$PROJECT_ROOT/.env" 2>/dev/null; then
        echo "ERROR: .env file has syntax errors. Please fix before continuing." >&2
        exit 1
    fi
    # shellcheck disable=SC1091
    if ! source "$PROJECT_ROOT/.env"; then
        echo "ERROR: Failed to source .env file" >&2
        exit 1
    fi
fi

# Default values
GATEWAY_URL="${GATEWAY_URL:-http://localhost:4444}"

# Helper functions
info() {
    echo -e "${BLUE}â„¹${NC} $*"
}

success() {
    echo -e "${GREEN}âœ“${NC} $*"
}

error() {
    echo -e "${RED}âœ—${NC} $*" >&2
}

warn() {
    echo -e "${YELLOW}âš ${NC} $*"
}

usage() {
    cat <<EOF
MCP Gateway Unified CLI Tool

Usage: mcp <command> [options]

Commands:
  init                 Initialize MCP Gateway project
  start                Start the gateway stack
  stop                 Stop the gateway stack
  status               Check gateway health and status
  restart              Restart the gateway stack

  server               Manage virtual servers
    list               List all virtual servers
    enable <name>      Enable a virtual server
    disable <name>     Disable a virtual server
    info <name>        Get server details

  ide                  IDE configuration tools
    setup              Interactive IDE setup wizard
    config             Generate IDE configuration
    detect             Auto-detect installed IDEs

  wizard               Interactive setup wizard
  logs [service]       View gateway logs (all, gateway, tool-router, etc.)
  doctor               Run health checks and diagnostics
  completion <shell>   Generate shell completion script (bash, zsh, fish)
  help                 Show this help message

Examples:
  mcp init                        # Initialize project
  mcp start                       # Start gateway
  mcp logs                        # View all logs
  mcp logs gateway                # View gateway logs only
  mcp doctor                      # Run health checks
  mcp server list                 # List all servers
  mcp server enable cursor-search # Enable a server
  mcp ide setup                   # Run IDE setup wizard
  mcp completion bash             # Generate bash completion

For more information, see: https://github.com/lucassantana/mcp-gateway
EOF
}

# Command: init
cmd_init() {
    info "Initializing MCP Gateway..."

    # Check prerequisites
    if ! command -v docker &> /dev/null; then
        error "Docker is not installed. Please install Docker first."
        exit 1
    fi

    if ! command -v docker-compose &> /dev/null && ! docker compose version &> /dev/null; then
        error "Docker Compose is not installed. Please install Docker Compose first."
        exit 1
    fi

    # Create .env if it doesn't exist
    if [ ! -f "$PROJECT_ROOT/.env" ]; then
        if [ -f "$PROJECT_ROOT/.env.example" ]; then
            info "Creating .env from .env.example..."
            cp "$PROJECT_ROOT/.env.example" "$PROJECT_ROOT/.env"
            success ".env file created"
        else
            warn ".env.example not found, skipping .env creation"
        fi
    else
        info ".env file already exists"
    fi

    # Create data directory
    mkdir -p "$PROJECT_ROOT/data"
    success "Data directory ready"

    success "MCP Gateway initialized successfully!"
    info "Next steps:"
    echo "  1. Review and update .env file if needed"
    echo "  2. Run: mcp start"
    echo "  3. Run: mcp ide setup"
}

# Command: start
cmd_start() {
    info "Starting MCP Gateway..."
    cd "$PROJECT_ROOT"
    make start
}

# Command: stop
cmd_stop() {
    info "Stopping MCP Gateway..."
    cd "$PROJECT_ROOT"
    make stop
}

# Command: status
cmd_status() {
    info "Checking gateway status..."
    cd "$PROJECT_ROOT"

    # Check if containers are running
    if docker compose ps | grep -q "Up"; then
        success "Gateway is running"
        docker compose ps
    else
        warn "Gateway is not running"
        echo "Run 'mcp start' to start the gateway"
    fi
}

# Command: restart
cmd_restart() {
    info "Restarting MCP Gateway..."
    cmd_stop
    sleep 2
    cmd_start
}

# Command: logs
cmd_logs() {
    local service="${1:-all}"

    info "Viewing logs for: $service"
    cd "$PROJECT_ROOT"

    case "$service" in
        all)
            docker compose logs -f --tail=100
            ;;
        gateway|tool-router|ollama|postgres|redis|uiforge)
            docker compose logs -f --tail=100 "$service"
            ;;
        *)
            error "Unknown service: $service"
            echo "Available services: all, gateway, tool-router, ollama, postgres, redis, uiforge"
            exit 1
            ;;
    esac
}

# Command: doctor
cmd_doctor() {
    info "Running MCP Gateway health checks..."
    echo ""

    local issues=0

    # Check 1: Docker
    echo "ğŸ” Checking Docker..."
    if command -v docker &> /dev/null; then
        if docker info &> /dev/null; then
            success "Docker is installed and running"
        else
            error "Docker is installed but not running"
            echo "   â†’ Start Docker Desktop or Docker daemon"
            issues=$((issues + 1))
        fi
    else
        error "Docker is not installed"
        echo "   â†’ Install Docker from https://docker.com"
        issues=$((issues + 1))
    fi

    # Check 2: Docker Compose
    echo "ğŸ” Checking Docker Compose..."
    if command -v docker-compose &> /dev/null || docker compose version &> /dev/null; then
        success "Docker Compose is available"
    else
        error "Docker Compose is not installed"
        echo "   â†’ Install Docker Compose"
        issues=$((issues + 1))
    fi

    # Check 3: Python
    echo "ğŸ” Checking Python..."
    if command -v python3 &> /dev/null; then
        local python_version
        python_version=$(python3 --version 2>&1 | cut -d' ' -f2)
        success "Python is installed (version $python_version)"
    else
        warn "Python3 is not installed (optional for tool_router)"
        echo "   â†’ Install Python 3.9+ for tool_router MCP server"
    fi

    # Check 4: Configuration files
    echo "ğŸ” Checking configuration..."
    if [ -f "$PROJECT_ROOT/.env" ]; then
        success ".env file exists"
    else
        warn ".env file not found"
        echo "   â†’ Run 'mcp init' to create .env file"
        issues=$((issues + 1))
    fi

    if [ -f "$PROJECT_ROOT/config/virtual-servers.txt" ]; then
        local server_count
        server_count=$(grep -v '^#' "$PROJECT_ROOT/config/virtual-servers.txt" | grep -v '^[[:space:]]*$' | wc -l | tr -d ' ')
        success "Virtual servers configured ($server_count servers)"
    else
        warn "Virtual servers configuration not found"
        issues=$((issues + 1))
    fi

    # Check 5: Gateway status
    echo "ğŸ” Checking gateway status..."
    cd "$PROJECT_ROOT"
    if docker compose ps 2>/dev/null | grep -q "Up"; then
        success "Gateway is running"

        # Check gateway health endpoint
        if command -v curl &> /dev/null; then
            if curl -sf "$GATEWAY_URL/health" &> /dev/null; then
                success "Gateway health endpoint responding"
            else
                warn "Gateway health endpoint not responding"
                echo "   â†’ Gateway may still be starting up"
            fi
        fi
    else
        warn "Gateway is not running"
        echo "   â†’ Run 'mcp start' to start the gateway"
    fi

    # Check 6: Disk space
    echo "ğŸ” Checking disk space..."
    local available_space
    available_space=$(df -h "$PROJECT_ROOT" | awk 'NR==2 {print $4}')
    success "Available disk space: $available_space"

    # Summary
    echo ""
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    if [ $issues -eq 0 ]; then
        success "All checks passed! Your MCP Gateway is healthy."
    else
        warn "Found $issues issue(s) that need attention."
        echo ""
        echo "ğŸ’¡ Quick fixes:"
        echo "   â€¢ Run 'mcp init' to initialize the project"
        echo "   â€¢ Run 'mcp start' to start the gateway"
        echo "   â€¢ Check Docker Desktop is running"
    fi
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
}

# Command: completion
cmd_completion() {
    local shell="${1:-bash}"

    # Validate shell against allowlist to prevent path traversal
    case "$shell" in
        bash|zsh|fish)
            # Valid shell
            ;;
        *)
            error "Invalid shell: '$shell'"
            echo "Available shells: bash, zsh, fish"
            exit 1
            ;;
    esac

    local completion_file="$SCRIPT_DIR/completions/mcp.$shell"

    if [ ! -f "$completion_file" ]; then
        error "Completion script for '$shell' not found"
        echo "Available shells: bash, zsh, fish"
        exit 1
    fi

    cat "$completion_file"
    echo ""
    echo "# Installation instructions:"
    case "$shell" in
        bash)
            echo "# Copy the output to: /etc/bash_completion.d/mcp"
            echo "# Or add to ~/.bashrc:"
            echo "#   source <(mcp completion bash)"
            ;;
        zsh)
            echo "# Copy the output to: /usr/local/share/zsh/site-functions/_mcp"
            echo "# Or add to ~/.zshrc:"
            echo "#   source <(mcp completion zsh)"
            ;;
        fish)
            echo "# Copy the output to: ~/.config/fish/completions/mcp.fish"
            echo "# Or run:"
            echo "#   mcp completion fish > ~/.config/fish/completions/mcp.fish"
            ;;
    esac
}

# Command: server list
cmd_server_list() {
    info "Listing virtual servers..."
    cd "$PROJECT_ROOT"
    make list-enabled
}

# Command: server enable
cmd_server_enable() {
    local server_name="$1"
    if [ -z "$server_name" ]; then
        error "Server name is required"
        echo "Usage: mcp server enable <name>"
        exit 1
    fi

    info "Enabling server: $server_name"
    cd "$PROJECT_ROOT"
    make enable-server SERVER="$server_name"
}

# Command: server disable
cmd_server_disable() {
    local server_name="$1"
    if [ -z "$server_name" ]; then
        error "Server name is required"
        echo "Usage: mcp server disable <name>"
        exit 1
    fi

    info "Disabling server: $server_name"
    cd "$PROJECT_ROOT"
    make disable-server SERVER="$server_name"
}

# Command: server info
cmd_server_info() {
    local server_name="$1"
    if [ -z "$server_name" ]; then
        error "Server name is required"
        echo "Usage: mcp server info <name>"
        exit 1
    fi

    info "Getting server info: $server_name"
    cd "$PROJECT_ROOT"

    # Use REST API to get server status
    if command -v curl &> /dev/null; then
        # Capture HTTP status and response body separately
        response=$(mktemp)
        http_status=$(curl -sS -w "%{http_code}" -o "$response" "$GATEWAY_URL/api/virtual-servers/$server_name")

        if [[ "$http_status" =~ ^2[0-9][0-9]$ ]]; then
            # Success - parse JSON response
            if command -v jq &> /dev/null; then
                jq '.' "$response" || cat "$response"
            else
                cat "$response"
            fi
        else
            # Error - show status and raw response
            echo "ERROR: HTTP $http_status" >&2
            echo "Response:" >&2
            head -c 500 "$response" >&2
            echo "" >&2
        fi
        rm -f "$response"
    else
        warn "curl not found, cannot fetch server info"
        echo "Install curl or check server status in config/virtual-servers.txt"
    fi
}

# Command: ide detect
cmd_ide_detect() {
    info "Detecting installed IDEs..."

    local found_ides=()

    # Check for Windsurf
    if [ -d "$HOME/.windsurf" ] || [ -d "$HOME/Library/Application Support/Windsurf" ]; then
        found_ides+=("windsurf")
        success "Found: Windsurf"
    fi

    # Check for Cursor
    if [ -d "$HOME/.cursor" ] || [ -d "$HOME/Library/Application Support/Cursor" ]; then
        found_ides+=("cursor")
        success "Found: Cursor"
    fi

    if [ ${#found_ides[@]} -eq 0 ]; then
        warn "No IDEs detected"
        echo "Supported IDEs: Windsurf, Cursor"
    else
        info "Detected ${#found_ides[@]} IDE(s)"
    fi
}

# Command: ide config
cmd_ide_config() {
    info "Generating IDE configuration..."
    cd "$PROJECT_ROOT"

    # Interactive prompts
    echo ""
    echo "Select IDE:"
    echo "  1) Windsurf"
    echo "  2) Cursor"
    read -rp "Choice [1]: " ide_choice
    ide_choice="${ide_choice:-1}"

    case "$ide_choice" in
        1) ide="windsurf" ;;
        2) ide="cursor" ;;
        *) error "Invalid choice"; exit 1 ;;
    esac

    make "ide-$ide"
}

# Command: ide setup (wizard)
cmd_ide_setup() {
    info "Starting IDE setup wizard..."

    # Detect IDEs
    cmd_ide_detect

    echo ""
    read -rp "Which IDE would you like to configure? [windsurf/cursor]: " ide
    ide="${ide:-windsurf}"

    if [ "$ide" != "windsurf" ] && [ "$ide" != "cursor" ]; then
        error "Invalid IDE. Choose 'windsurf' or 'cursor'"
        exit 1
    fi

    # List available servers with enhanced formatting
    echo ""
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "ğŸ“¦ Available Virtual Servers"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo ""

    # Try JSON first, fall back to TXT
    if [ -f "$PROJECT_ROOT/config/virtual-servers.json" ]; then
        # Parse JSON and display servers with icons and categories
        if command -v jq &> /dev/null; then
            # Use jq for proper JSON parsing
            jq -r '
                .categories | to_entries[] |
                "\(.value.icon) \(.value.name):",
                (.value.servers[] |
                    if .enabled then
                        "  \(.icon) \(.name)|\(.gateways | length)|\(.description // "")"
                    else empty end
                )
            ' "$PROJECT_ROOT/config/virtual-servers.json" | while IFS= read -r line; do
                if [[ "$line" =~ ^[[:space:]]*[ğŸ”§ğŸš€] ]]; then
                    # Category header
                    echo "$line"
                else
                    # Server entry
                    IFS='|' read -r name_icon count desc <<< "$line"
                    # Color code based on category
                    if [[ "$name_icon" =~ (â­|ğŸ”€|ğŸ”|ğŸŒ|ğŸ“|ğŸ’¾|ğŸ¯) ]]; then
                        # Legacy - green
                        printf "%s \033[1;32m%-30s\033[0m \033[2m(%s tools)\033[0m\n" \
                            "$(echo "$name_icon" | awk '{print $1}')" \
                            "$(echo "$name_icon" | awk '{$1=""; print substr($0,2)}')" \
                            "$count"
                    else
                        # Optimized - cyan
                        printf "%s \033[1;36m%-30s\033[0m \033[2m(%s tools)\033[0m\n" \
                            "$(echo "$name_icon" | awk '{print $1}')" \
                            "$(echo "$name_icon" | awk '{$1=""; print substr($0,2)}')" \
                            "$count"
                    fi
                fi
            done
        else
            # Fallback: simple parsing without jq
            warn "jq not found, using basic JSON parsing"
            grep -o '"name"[[:space:]]*:[[:space:]]*"[^"]*"' "$PROJECT_ROOT/config/virtual-servers.json" | \
                cut -d'"' -f4 | while read -r name; do
                printf "  â€¢ \033[1;36m%-30s\033[0m\n" "$name"
            done
        fi
    elif [ -f "$PROJECT_ROOT/config/virtual-servers.txt" ]; then
        # Legacy TXT format support
        warn "Using legacy .txt format. Consider migrating to JSON."
        echo "ğŸ”§ Legacy Profiles:"
        grep -v '^#' "$PROJECT_ROOT/config/virtual-servers.txt" | grep -v '^[[:space:]]*$' | head -7 | while IFS='|' read -r name tools rest; do
            icon="  â€¢"
            case "$name" in
                *router*) icon="  ğŸ”€" ;;
                *default*) icon="  â­" ;;
                *search*) icon="  ğŸ”" ;;
                *browser*) icon="  ğŸŒ" ;;
                *git*) icon="  ğŸ“" ;;
                database*) icon="  ğŸ’¾" ;;
                fullstack*) icon="  ğŸ¯" ;;
            esac
            tool_count=$(echo "$tools" | tr ',' '\n' | wc -l | tr -d ' ')
            printf "%s \033[1;32m%-30s\033[0m \033[2m(%s tools)\033[0m\n" "$icon" "$name" "$tool_count"
        done

        echo ""
        echo "ğŸš€ Optimized Stacks:"
        grep -v '^#' "$PROJECT_ROOT/config/virtual-servers.txt" | grep -v '^[[:space:]]*$' | tail -n +8 | while IFS='|' read -r name tools rest; do
            icon="  â€¢"
            case "$name" in
                nodejs*) icon="  ğŸ“—" ;;
                react*) icon="  âš›ï¸ " ;;
                mobile*) icon="  ğŸ“±" ;;
                database*) icon="  ğŸ’¾" ;;
                java*) icon="  â˜•" ;;
                python*) icon="  ğŸ" ;;
                aws*) icon="  â˜ï¸ " ;;
                testing*) icon="  ğŸ§ª" ;;
                code-quality*) icon="  âœ¨" ;;
                fullstack*) icon="  ğŸ¯" ;;
                monorepo*) icon="  ğŸ“¦" ;;
                devops*) icon="  ğŸ”§" ;;
                *minimal*) icon="  âš¡" ;;
            esac
            tool_count=$(echo "$tools" | tr ',' '\n' | wc -l | tr -d ' ')
            printf "%s \033[1;36m%-30s\033[0m \033[2m(%s tools)\033[0m\n" "$icon" "$name" "$tool_count"
        done
    else
        warn "No virtual servers configured yet"
        echo "  Run './scripts/gateway/register.sh' first"
        exit 1
    fi

    echo ""
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo ""
    read -rp "Which server would you like to connect to? [router]: " server
    server="${server:-router}"

    # Generate config
    cd "$PROJECT_ROOT"
    info "Generating $ide configuration for server: $server"
    make "ide-$ide" SERVER="$server"

    success "IDE configuration generated!"
    info "Next steps:"
    echo "  1. Copy the configuration above"
    echo "  2. Open your $ide settings"
    echo "  3. Navigate to: Settings â†’ MCP Servers"
    echo "  4. Paste the configuration"
    echo "  5. Restart your IDE"
}

# Command: wizard
cmd_wizard() {
    clear
    cat <<EOF
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘          MCP Gateway Interactive Setup Wizard              â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

This wizard will help you set up MCP Gateway in a few simple steps.

EOF

    # Step 1: Check if initialized
    if [ ! -f "$PROJECT_ROOT/.env" ]; then
        info "Step 1: Initialize project"
        cmd_init
        echo ""
    else
        success "Project already initialized"
        echo ""
    fi

    # Step 2: Start gateway
    info "Step 2: Start gateway"
    read -rp "Start the gateway now? [Y/n]: " start_now
    start_now="${start_now:-Y}"

    # Normalize to lowercase and accept common variations
    start_now_lower=$(echo "$start_now" | tr '[:upper:]' '[:lower:]')
    if [[ "$start_now_lower" == "y" || "$start_now_lower" == "yes" ]]; then
        cmd_start
        echo ""
        info "Waiting for gateway to be ready..."
        sleep 5
    fi

    # Step 3: IDE setup
    info "Step 3: Configure IDE"
    read -rp "Configure an IDE now? [Y/n]: " config_ide
    config_ide="${config_ide:-Y}"

    if [[ "$config_ide" =~ ^[Yy]$ ]]; then
        cmd_ide_setup
    fi

    echo ""
    success "Setup complete!"
    info "Your MCP Gateway is ready to use."
    echo ""
    echo "Useful commands:"
    echo "  mcp status          - Check gateway status"
    echo "  mcp server list     - List all servers"
    echo "  mcp ide config      - Generate IDE config"
    echo "  mcp help            - Show all commands"
}

# Main command router
main() {
    if [ $# -eq 0 ]; then
        usage
        exit 0
    fi

    case "$1" in
        init)
            cmd_init
            ;;
        start)
            cmd_start
            ;;
        stop)
            cmd_stop
            ;;
        status)
            cmd_status
            ;;
        restart)
            cmd_restart
            ;;
        server)
            shift
            case "${1:-}" in
                list)
                    cmd_server_list
                    ;;
                enable)
                    shift
                    cmd_server_enable "$@"
                    ;;
                disable)
                    shift
                    cmd_server_disable "$@"
                    ;;
                info)
                    shift
                    cmd_server_info "$@"
                    ;;
                *)
                    error "Unknown server command: ${1:-}"
                    echo "Usage: mcp server {list|enable|disable|info}"
                    exit 1
                    ;;
            esac
            ;;
        ide)
            shift
            case "${1:-}" in
                setup)
                    cmd_ide_setup
                    ;;
                config)
                    cmd_ide_config
                    ;;
                detect)
                    cmd_ide_detect
                    ;;
                *)
                    error "Unknown ide command: ${1:-}"
                    echo "Usage: mcp ide {setup|config|detect}"
                    exit 1
                    ;;
            esac
            ;;
        wizard)
            cmd_wizard
            ;;
        logs)
            shift
            cmd_logs "$@"
            ;;
        doctor)
            cmd_doctor
            ;;
        completion)
            shift
            cmd_completion "$@"
            ;;
        help|--help|-h)
            usage
            ;;
        *)
            error "Unknown command: $1"
            echo ""
            usage
            exit 1
            ;;
    esac
}

main "$@"
