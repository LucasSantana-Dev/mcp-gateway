version: '3.8'

services:
  # PostgreSQL database for Sentry
  postgres:
    image: postgres:15-alpine
    restart: always
    environment:
      POSTGRES_DB: sentry
      POSTGRES_USER: sentry
      POSTGRES_PASSWORD: ${SENTRY_DB_PASSWORD:-sentry_password_change_me}
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./init.sql:/docker-entrypoint-initdb.d/init.sql
    networks:
      - sentry-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U sentry"]
      interval: 30s
      timeout: 10s
      retries: 5

  # Redis for caching and session management
  redis:
    image: redis:7-alpine
    restart: always
    command: redis-server --maxmemory 512mb --maxmemory-policy allkeys-lru
    volumes:
      - redis_data:/data
    networks:
      - sentry-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 30s
      timeout: 10s
      retries: 5

  # Sentry Web service
  web:
    image: sentry:8.15
    restart: always
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    environment:
      SENTRY_SECRET_KEY: ${SENTRY_SECRET_KEY:-change_me_to_a_long_random_string}
      SENTRY_DB_HOST: postgres
      SENTRY_DB_NAME: sentry
      SENTRY_DB_USER: sentry
      SENTRY_DB_PASSWORD: ${SENTRY_DB_PASSWORD:-sentry_password_change_me}
      SENTRY_REDIS_HOST: redis
      SENTRY_WEB_HOST: 0.0.0.0
      SENTRY_WEB_PORT: 9000
      SENTRY_EMAIL_HOST: smtp
      SENTRY_EMAIL_PORT: 587
      SENTRY_EMAIL_USER: ${SENTRY_EMAIL_USER:-}
      SENTRY_EMAIL_PASSWORD: ${SENTRY_EMAIL_PASSWORD:-}
      SENTRY_EMAIL_USE_TLS: "true"
      SENTRY_SERVER_EMAIL: ${SENTRY_SERVER_EMAIL:-sentry@localhost}
      SENTRY_SYSTEM_ADMIN_EMAIL: ${SENTRY_ADMIN_EMAIL:-admin@localhost}
      SENTRY_SINGLE_ORGANIZATION: "true"
      SENTRY_SELF_HOSTED: "true"
      SENTRY_OPTIONS: {
        "system.url-prefix": "http://localhost:9000",
        "system.admin-email": "${SENTRY_ADMIN_EMAIL:-admin@localhost}",
        "auth.allow-registration": "false"
      }
    ports:
      - "9000:9000"
    volumes:
      - sentry_data:/var/lib/sentry/files
    networks:
      - sentry-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:9000/_health/"]
      interval: 30s
      timeout: 10s
      retries: 5

  # Sentry worker for processing background tasks
  worker:
    image: sentry:8.15
    restart: always
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    command: ["sentry", "run", "worker"]
    environment:
      SENTRY_SECRET_KEY: ${SENTRY_SECRET_KEY:-change_me_to_a_long_random_string}
      SENTRY_DB_HOST: postgres
      SENTRY_DB_NAME: sentry
      SENTRY_DB_USER: sentry
      SENTRY_DB_PASSWORD: ${SENTRY_DB_PASSWORD:-sentry_password_change_me}
      SENTRY_REDIS_HOST: redis
    volumes:
      - sentry_data:/var/lib/sentry/files
    networks:
      - sentry-network

  # Sentry cron job for periodic tasks
  cron:
    image: sentry:8.15
    restart: always
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    command: ["sentry", "run", "cron"]
    environment:
      SENTRY_SECRET_KEY: ${SENTRY_SECRET_KEY:-change_me_to_a_long_random_string}
      SENTRY_DB_HOST: postgres
      SENTRY_DB_NAME: sentry
      SENTRY_DB_USER: sentry
      SENTRY_DB_PASSWORD: ${SENTRY_DB_PASSWORD:-sentry_password_change_me}
      SENTRY_REDIS_HOST: redis
    volumes:
      - sentry_data:/var/lib/sentry/files
    networks:
      - sentry-network

  # Nginx reverse proxy (optional, for SSL termination)
  nginx:
    image: nginx:alpine
    restart: always
    depends_on:
      web:
        condition: service_healthy
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
      - ./ssl:/etc/nginx/ssl:ro
    networks:
      - sentry-network
    profiles:
      - production

volumes:
  postgres_data:
    driver: local
  redis_data:
    driver: local
  sentry_data:
    driver: local

networks:
  sentry-network:
    driver: bridge