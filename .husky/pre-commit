#!/bin/bash
# pre-commit hook â€” forge-patterns gate
set -euo pipefail

echo "ğŸš€ Running UIForge pre-commit validations..."

FAILED=0

# 1. Security validation
if [ -f "scripts/security/validate-no-secrets.sh" ]; then
  echo "ğŸ”’ Running security validation..."
  if ! bash scripts/security/validate-no-secrets.sh; then
    echo "âŒ Security validation failed."
    FAILED=1
  else
    echo "âœ… Security validation passed."
  fi
fi

# 2. Python linting (ruff)
if [ -f "pyproject.toml" ] || [ -f "requirements.txt" ]; then
  echo "ğŸ Running Python lint..."
  if command -v ruff &>/dev/null; then
    if ! ruff check .; then
      echo "âŒ Python lint failed."
      FAILED=1
    else
      echo "âœ… Python lint passed."
    fi
  fi
fi

# 3. Node.js lint (if applicable)
if [ -f "package.json" ]; then
  echo "ğŸ“ Running lint-staged..."
  if ! npx lint-staged; then
    echo "âŒ Lint/format check failed."
    FAILED=1
  else
    echo "âœ… Lint/format check passed."
  fi
fi

# 4. TypeScript type check
if [ -f "tsconfig.json" ]; then
  echo "ğŸ” Running type check..."
  if ! npx tsc --noEmit; then
    echo "âŒ Type check failed."
    FAILED=1
  else
    echo "âœ… Type check passed."
  fi
fi

# 5. Fast tests
echo "ğŸ§ª Running tests..."
if command -v pytest &>/dev/null; then
  if ! pytest -x --timeout=30 -q 2>/dev/null; then
    echo "âŒ Tests failed."
    FAILED=1
  else
    echo "âœ… Tests passed."
  fi
fi

if [ $FAILED -eq 0 ]; then
  echo "âœ… All pre-commit validations passed!"
else
  echo "âŒ Some validations failed. Please fix the issues above."
  exit 1
fi
