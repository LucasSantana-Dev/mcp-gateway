# Optimized Docker Compose with advanced features
# syntax=docker/dockerfile:1.6

x-common: &common
  restart: unless-stopped
  logging:
    driver: json-file
    options:
      max-size: 5m
      max-file: 2
  ulimits:
    nofile:
      soft: 1024
      hard: 2048

x-translate: &translate
  <<: *common
  image: forge-mcp-gateway-translate:latest
  deploy:
    resources:
      limits:
        cpus: "0.25"
        memory: 128M
        pids: 20
      reservations:
        cpus: "0.05"
        memory: 64M
  memswap_limit: 192M
  environment:
    FORGE_MAX_REQUEST_SIZE: "${FORGE_MAX_REQUEST_SIZE}"
    FORGE_SLEEP_POLICY_ENABLED: "true"
    FORGE_WAKE_TIME_TARGET: "200"

services:
  # Core Gateway Services - Optimized
  gateway:
    <<: *common
    image: ghcr.io/ibm/mcp-gateway:latest
    container_name: forge-mcpgateway
    entrypoint: ["/app/docker/entrypoint.sh"]
    ports:
      - "${GATEWAY_PORT:-4444}:4444"
    env_file:
      - .env.shared
      - .env.development
    environment:
      HOST: ${GATEWAY_HOST:-0.0.0.0}
      PORT: ${GATEWAY_PORT:-4444}
      DATABASE_URL: ${DATABASE_URL:-sqlite:////data/mcp.db}
      FORGE_ENABLE_DYNAMIC_SERVICES: true
      FORGE_SERVICE_MANAGER_URL: http://service-manager:9000
      SKIP_MIGRATIONS: true
      # Performance optimizations
      PYTHONOPTIMIZE: 2
      PYTHONDONTWRITEBYTECODE: 1
    volumes:
      - ./data:/data
      - ./docker/entrypoint.sh:/app/docker/entrypoint.sh:ro
      - ./docker/minimal_gateway.py:/app/docker/minimal_gateway.py:ro
    depends_on:
      service-manager:
        condition: service_healthy
      tool-router:
        condition: service_healthy
    deploy:
      resources:
        limits:
          cpus: "0.5"
          memory: 512M
          pids: 50
        reservations:
          cpus: "0.1"
          memory: 256M
    memswap_limit: 768M
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:4444/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Service Manager with enhanced monitoring
  service-manager:
    build:
      context: ./service-manager
      dockerfile: Dockerfile
      target: production  # Multi-stage build target
    container_name: forge-service-manager
    ports:
      - "${FORGE_SERVICE_MANAGER_PORT:-9000}:9000"
    volumes:
      - ./config:/config:ro
      - /var/run/docker.sock:/var/run/docker.sock
      - ./data:/data
    environment:
      - CONFIG_PATH=/config
      - LOG_LEVEL=${FORGE_SERVICE_MANAGER_LOG_LEVEL:-info}
      - DATA_PATH=/data
      - DOCKER_HOST=unix:///var/run/docker.sock
      # Performance settings
      - PYTHONOPTIMIZE=2
      - PYTHONDONTWRITEBYTECODE=1
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    deploy:
      resources:
        limits:
          cpus: "0.25"
          memory: 256M
          pids: 30
        reservations:
          cpus: "0.1"
          memory: 128M
    memswap_limit: 384M

  # Tool Router with BuildKit optimizations
  tool-router:
    build:
      context: .
      dockerfile: Dockerfile.tool-router.optimized
      target: runtime
      cache_from:
        - forge-mcp-gateway-tool-router:latest
      args:
        BUILDKIT_INLINE_CACHE: 1
    image: forge-mcp-gateway-tool-router:latest
    env_file:
      - .env.shared
      - .env.development
    environment:
      FORGE_GATEWAY_URL: http://gateway:4444
      FORGE_ENABLE_HEALTH_CHECK: ${FORGE_ENABLE_HEALTH_CHECK}
      FORGE_SERVICE_MANAGER_URL: http://service-manager:9000
      # AI Router Configuration
      ROUTER_AI_ENABLED: ${ROUTER_AI_ENABLED:-false}
      ROUTER_AI_PROVIDER: ${ROUTER_AI_PROVIDER:-ollama}
      ROUTER_AI_MODEL: ${ROUTER_AI_MODEL:-llama3.2:3b}
      ROUTER_AI_ENDPOINT: ${ROUTER_AI_ENDPOINT:-http://ollama:11434}
      ROUTER_AI_TIMEOUT_MS: ${ROUTER_AI_TIMEOUT_MS:-2000}
      ROUTER_AI_WEIGHT: ${ROUTER_AI_WEIGHT:-0.7}
      # Performance optimizations
      PYTHONOPTIMIZE: 2
      PYTHONDONTWRITEBYTECODE: 1
    ports:
      - "${FORGE_TOOL_ROUTER_PORT:-8030}:8030"
    depends_on:
      service-manager:
        condition: service_healthy
      ollama:
        condition: service_healthy
    deploy:
      resources:
        limits:
          cpus: "0.25"
          memory: 256M
          pids: 30
        reservations:
          cpus: "0.1"
          memory: 128M
    memswap_limit: 384M
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8030/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Ollama with resource optimization
  ollama:
    image: ollama/ollama:latest
    container_name: forge-ollama
    ports:
      - "${OLLAMA_PORT:-11434}:11434"
    volumes:
      - ollama_data:/root/.ollama
    environment:
      - OLLAMA_MODELS=${ROUTER_AI_MODEL:-llama3.2:3b}
      - OLLAMA_MAX_QUEUE=512
      - OLLAMA_NUM_PARALLEL=2
    deploy:
      resources:
        limits:
          cpus: "1.0"
          memory: 2G
          pids: 50
        reservations:
          cpus: "0.25"
          memory: 512M
    memswap_limit: 3G
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:11434/api/tags"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  # Admin UI with optimizations
  forge-ui:
    build:
      context: .
      dockerfile: Dockerfile.uiforge.consolidated
      target: production
    image: forge-mcp-gateway-ui:latest
    env_file:
      - .env.shared
      - .env.development
    volumes:
      - ./data-dev:/data-dev
    ports:
      - "${FORGE_UI_PORT:-8026}:8026"
    depends_on:
      gateway:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8026/health || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 15s
    deploy:
      resources:
        limits:
          cpus: "0.5"
          memory: 512M
          pids: 50
        reservations:
          cpus: "0.1"
          memory: 256M
    memswap_limit: 768M

  # Core translate service with enhanced efficiency
  forge-translate:
    <<: *translate
    container_name: forge-translate
    ports:
      - "${FORGE_TRANSLATE_PORT:-8000}:8000"
    environment:
      FORGE_SERVICE_MODE: manager
      FORGE_MAX_REQUEST_SIZE: ${FORGE_MAX_REQUEST_SIZE}
      FORGE_SLEEP_POLICY_ENABLED: true
      FORGE_SERVICE_PRIORITY: normal
      FORGE_AUTO_START: false
      FORGE_IDLE_TIMEOUT: 300
      FORGE_MIN_SLEEP_TIME: 60
      FORGE_MEMORY_RESERVATION: 64MB
      FORGE_WAKE_TIME_TARGET: 200
    healthcheck:
      test: ["CMD", "python3", "-c", "import mcpgateway.translate; import sys; sys.exit(0)"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s

volumes:
  ollama_data:
    driver: local

# BuildKit configuration for this compose file
x-buildkit: &buildkit
  args:
    BUILDKIT_INLINE_CACHE: 1
  cache_from:
    - type=registry,ref=forge-mcp-gateway-tool-router:cache
