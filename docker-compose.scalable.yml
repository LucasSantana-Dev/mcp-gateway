# Scalable Docker Compose Configuration for Forge MCP Gateway
# This file implements the scalable architecture with dynamic service management
# and serverless-like sleep/wake capabilities

services:
  # Core Gateway Service (Never Sleeps)
  gateway:
    image: ghcr.io/ibm/mcp-gateway:latest
    container_name: forge-mcpgateway
    restart: unless-stopped
    ports:
      - "${GATEWAY_PORT:-4444}:4444"
    env_file:
      - .env.shared
      - .env.development
    environment:
      HOST: ${GATEWAY_HOST:-0.0.0.0}
      PORT: ${GATEWAY_PORT:-4444}
      DATABASE_URL: ${DATABASE_URL:-sqlite:////data/mcp.db}
      FORGE_ENABLE_DYNAMIC_SERVICES: true
      FORGE_ENABLE_SERVICE_DISCOVERY: true
      FORGE_ENABLE_AUTO_SCALING: true
      FORGE_ENABLE_SLEEP_POLICIES: true
      FORGE_SERVICE_MANAGER_URL: http://service-manager:9000
      FORGE_ENABLE_SERVERLESS_MODE: true
    volumes:
      - ./data:/data
      - ./config:/config:ro
    depends_on:
      service-manager:
        condition: service_healthy
      tool-router:
        condition: service_started
    deploy:
      resources:
        limits:
          cpus: "0.5"
          memory: 512M
        reservations:
          cpus: "0.1"
          memory: 256M
      restart_policy:
        condition: unless-stopped
    memswap_limit: 768M
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:4444/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    logging:
      driver: json-file
      options:
        max-size: 10m
        max-file: 3

  # Service Manager (Never Sleeps)
  service-manager:
    build:
      context: ./service-manager
      dockerfile: Dockerfile
    container_name: forge-service-manager
    restart: unless-stopped
    ports:
      - "${FORGE_SERVICE_MANAGER_PORT:-9000}:9000"
    volumes:
      - ./config:/config:ro
      - ./data:/data
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      - DOCKER_HOST=unix:///var/run/docker.sock
      - CONFIG_PATH=/config
      - LOG_LEVEL=${FORGE_SERVICE_MANAGER_LOG_LEVEL:-info}
      - SERVICE_MANAGER_PORT=9000
      - ENABLE_AUTO_SCALING=true
      - ENABLE_SLEEP_POLICIES=true
      - ENABLE_PREDICTIVE_WAKE=true
      - ENABLE_SERVERLESS_MODE=true
      - SLEEP_POLICY_INTERVAL=30
      - COST_OPTIMIZATION_ENABLED=true
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    deploy:
      resources:
        limits:
          cpus: "0.25"
          memory: 256M
          pids: 30
        reservations:
          cpus: "0.1"
          memory: 128M
      restart_policy:
        condition: unless-stopped
    memswap_limit: 384M
    logging:
      driver: json-file
      options:
        max-size: 5m
        max-file: 2

  # Tool Router (Never Sleeps)
  tool-router:
    build:
      context: ./tool_router
      dockerfile: Dockerfile
    container_name: forge-tool-router
    restart: unless-stopped
    ports:
      - "${FORGE_TOOL_ROUTER_PORT:-8030}:8030"
    environment:
      - FORGE_ENABLE_DYNAMIC_ROUTING=true
      - FORGE_ENABLE_LOAD_BALANCING=true
      - FORGE_ENABLE_CIRCUIT_BREAKER=true
      - FORGE_ENABLE_SERVICE_DISCOVERY=true
      - FORGE_SERVICE_MANAGER_URL=http://service-manager:9000
      - LOG_LEVEL=${FORGE_TOOL_ROUTER_LOG_LEVEL:-info}
    volumes:
      - ./config:/config:ro
      - ./data:/data
    depends_on:
      service-manager:
        condition: service_healthy
    deploy:
      resources:
        limits:
          cpus: "0.25"
          memory: 256M
          pids: 30
        reservations:
          cpus: "0.1"
          memory: 128M
      restart_policy:
        condition: unless-stopped
    memswap_limit: 384M
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8030/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    logging:
      driver: json-file
      options:
        max-size: 5m
        max-file: 2

  # Forge UI (Optional - Sleeps after inactivity)
  forge-ui:
    image: forge-mcp-gateway-translate:latest
    container_name: forge-ui
    restart: unless-stopped
    ports:
      - "${FORGE_UI_PORT:-3000}:3000"
    environment:
      - FORGE_SERVICE_MODE=managed
      - FORGE_ENABLE_SERVERLESS_MODE=true
      - FORGE_ENABLE_SLEEP_POLICIES=true
      - NODE_ENV=production
    volumes:
      - ./config:/config:ro
      - ./data:/data
    depends_on:
      service-manager:
        condition: service_healthy
    deploy:
      resources:
        limits:
          cpus: "0.25"
          memory: 256M
          pids: 30
        reservations:
          cpus: "0.05"
          memory: 128M
      restart_policy:
        condition: unless-stopped
    memswap_limit: 384M
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    logging:
      driver: json-file
      options:
        max-size: 5m
        max-file: 2

  # Core Translate Service (Never Sleeps)
  forge-translate:
    image: forge-mcp-gateway-translate:latest
    container_name: forge-translate
    restart: unless-stopped
    environment:
      - FORGE_SERVICE_MODE=managed
      - FORGE_ENABLE_SERVERLESS_MODE=true
      - FORGE_ENABLE_SLEEP_POLICIES=true
      - FORGE_SERVICE_PRIORITY=high
    volumes:
      - ./config:/config:ro
      - ./data:/data
    depends_on:
      service-manager:
        condition: service_healthy
    deploy:
      resources:
        limits:
          cpus: "0.25"
          memory: 256M
          pids: 30
        reservations:
          cpus: "0.05"
          memory: 128M
      restart_policy:
        condition: unless-stopped
    memswap_limit: 384M
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    logging:
      driver: json-file
      options:
        max-size: 5m
        max-file: 2

# Network Configuration
networks:
  default:
    driver: bridge
    ipam:
      driver: default
      config:
        - subnet: 172.21.0.0/16
          gateway: 172.21.0.1
    driver_opts:
      com.docker.network.bridge.enable_icc: "true"
      com.docker.network.bridge.enable_ip_masquerade: "true"
      com.docker.network.bridge.mtu: 1500

# Volume Configuration
volumes:
  data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ./data
  config:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ./config
